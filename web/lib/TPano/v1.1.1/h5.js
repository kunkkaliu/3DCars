(function(){"use strict";function Aa(){}function Ra(a,b,c){function d(){if(a){Sa(a,e);var f=(new Date).getTime(),s=f-h;e=b+(c-b)*(f-h)/ma.FADE_TIME;e=Math.min(100,e);e=Math.max(0,e);n++;g=.5*g+s/n*.5;s<ma.FADE_TIME?setTimeout(d,g):Sa(a,c)}}var e=b,f=ma.FADE_TIME/ma.FADE_FRAME_COUNT,g=f,h=(new Date).getTime(),n=0;setTimeout(d,f)}function Sa(a,b){for(var c=0;c<a.length;c++)a[c].setAlpha(b)}function C(a,b){if(this instanceof C)2==arguments.length?(this.x=a,this.y=b):this.y=this.x=0;else return new C(a,b)}function Ta(a){if(""===a.trim())return{};a=a.split("&");for(var b={},c=0,d=a.length;c<d;c++){var e=a[c].split("=");b[e[0]]=decodeURIComponent(e[1]||"")}return b}function ga(a,b,c){var d=(a+b+c)/2;return Math.sqrt(Math.abs(d*(d-a)*(d-b)*(d-c)))}function ca(a,b){return Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2)+Math.pow(a.z-b.z,2))}function Ba(a,b){return a.x*b.x+a.y*b.y+a.z*b.z}function Ua(a,b,c,d){var e=ca(a,b),f=ca(a,c),g=ca(a,d);a=ca(b,c);c=ca(c,d);d=ca(d,b);b=ga(e,f,a);f=ga(f,g,c);e=ga(g,d,e);a=ga(a,c,d);return.02>Math.abs(b+f+e-a)}function Va(a,b,c,d){c=(Ba(d,c)-Ba(d,a))/Ba(d,b);return 0<=c?{x:a.x+c*b.x,y:a.y+c*b.y,z:a.z+c*b.z}:null}function l(a,b,c,d){this.x=a||0;this.y=b||0;this.z=c||0;this.w=d||0}function Y(){var a=document.createElement("img");a.style.position="absolute";a.style.zIndex=2;a.alt="loading...";a.src=sb.blank;this.img=a}function K(a,b,c,d){this.x=a;this.y=b;this.width=c;this.height=d}function V(a,b){this.cidx=a;this.ridx=b;this.bounds=new tb(na*this.cidx,oa*this.ridx,na,oa);this.img=ub();var c=this.cidx,d=this.ridx,e=document.createElement("p");e.textContent=c+","+d;e.style.position="absolute";this.label=e;this.setViewSize(na,oa)}function ub(){var a=document.createElement("img");a.style.position="absolute";a.style.zIndex=1;a.alt="loading...";a.src=vb.blank;a.onload=function(b){a.style.zIndex=3};return a}function H(){this._listeners={};this.maxListeners=20}function Wa(a,b){this.pool=[];this.canvas=a;this.bindEvents=["touchstart","touchmove","touchend","mousedown","click"];this.bindEvent(b)}function Z(a){this.v=[];a?(this.v[0]=a[0],this.v[1]=a[1],this.v[2]=a[2],this.v[3]=a[3]):this.v[0]=this.v[1]=this.v[2]=this.v[3]=0}function x(a){a&&16==a.length?this.v=a:(this.v=[],this.identity())}function F(){Xa.apply(this);this.vertices=[];this.indices=[];this.uvtData=[];this._modelMatrix=new ha;this.texture=new Image;this.fixMatrix=[]}function pa(a){this.canvas=a;this._2dContext=a.getContext("2d")}function M(a){Ca.apply(this);this.eventCoords=[];this._super=new Ca;this.build();this.addEventWatch();this.createLabel()}function ia(a){Da.apply(this);this._super=new Da;Ea=a;this.build()}function qa(a,b,c,d){this.projectMatrix=new Ya;this.viewMatrix=new Ya;this.up=this.target=this.eye=null;this.fovy=a;this.aspect=b;this.near=c;this.far=d;this.updateProjectMatrix()}function R(a){this.world=[];this.canvas=a;this.renderer=this.camera=null;this.viewPortMatrix=new Za;this.coreMatrix=null;this.appParams={}}function W(){this.subRects=[]}function J(a,b){this._lastSvid=null;this._isSvidChanged=!0;this._thumbs2=this._thumbs=this._tiles2=this._tiles=this._lastThumbs=this._currentThumbs=this._lastTiles=this._currentTiles=null;this._pano=a;b.style.overflow="hidden";this._createTiles(b);this._createThumbs(b);this._fadeAnimation=new wb}function Fa(a,b,c){Ga.apply(this);this.eventCoords=[];this._super=new Ga;this.build(a);b&&c&&this.rotateSelf(b/360*Math.PI*2,c);this._isStopRender=!1;this.manager=null}function ra(a,b){return Math.sqrt(Math.pow(b.pageX-a.pageX,2)+Math.pow(b.pageY-a.pageY,2))}function N(a,b,c){this._panoDom=a;this._startTouch={pageX:null,pageY:null,timeStamp:null};this._lastDragEvt=this._clickTimer=this._touch2=this._startTouch=null;this._listener={onClick:null,onDbClick:null,onDragStart:null,onDrag:null,onDragEnd:null};this._listener=b;!1!==c&&this.enable()}function S(a,b){this._panorama=a;this._canvas=b;this._scene3d=new xb(this._canvas);this._eventAction=yb.getInstance(this._canvas,a._sceneMask);this._initTarget=null;var c=a.getViewWidth(),d=a.getViewHeight();this._scene3d.setCamera(zb(c,d));this._initTarget=this._scene3d.camera.target;this.syncLookup();this._canvas.width=c;this._canvas.height=d;this._scene3d.viewPort(0,0,c,d);this._scene3d.setRenderer(new Ab(this._canvas))}function zb(a,b){var c=new Bb(100*Math.PI/180,a/b,.1,1e3),d=new Ha(0,0,0),e=new Ha(0,0,-1),f=new Ha(0,1,0);c.lookAt(d,e,f);return c}function p(a,b){$a.apply(this);this._config=Object.create(Cb);this._config._THUMB_URL=b.thumbDomain;this._config._TILE_SITES=b.tileDomain;this._ZoomFactor=null;this._fovy=b.fovy;this._viewWidth=b.viewWidth;this._viewHeight=b.viewHeight;this._svid=b.svid;this._heading=b.heading||0;this._pitch=b.pitch||0;this._zoom=b.zoom||1;this._tileZoom=1;this._topPitch=-90;this._bottomPitch=50;this._isPreLoad=b.preload;this._animationId=null;this._tileManager=new Db(this,a);this._resetZoomFactor(1)}function ab(){return!1}function D(a,b){bb.call(this);this._svid=null;this._pitch=this._heading=0;this._baseFovy=this._fovy=b.fovy;this._viewWidth=b.viewWidth;this._viewHeight=b.viewHeight;this._level=1;this._tileCount=Math.pow(2,this._level);this._tileWidth=256;this._containerDom=a;this._tileContainer=null;this._cubeSideDivs=[];this._thumbImgs=[];this._renderId=null;this._doRender=I.bindThis(this._doRender,this);this._onThumbLoaded=I.bindThis(this._onThumbLoaded,this);this._onTileImgLoaded=I.bindThis(Eb,this);this._tileMgr=Fb();this._buildTilesContainer();this.setViewPort(b.viewWidth,b.viewHeight)}function Eb(a){a=a.target;a.style.transition="opacity 300ms ease-out";a.style.opacity=1;a=a.dataset;a=this._tileMgr.tileLoaded("i_"+a.x+"_"+a.y);1===a?this.dispatchEvent("tileLoaded"):0<a&&this.dispatchEvent("tileLoading",{percent:a})}function Gb(a,b){0<b.length&&this.manager.renderTile(this.imgID)}function cb(a,b,c){c=a._tileWidth/2*1*(a._level+1);c--;a="translate("+((a._viewWidth-a._tileWidth*a._tileCount)/2+"px")+","+((a._viewHeight-a._tileWidth*a._tileCount)/2+"px")+")";return 3>=b?a+" rotateY("+ -90*b+"deg) translateZ(-"+c+"px)":4==b?a+" rotateX(-90deg) translateZ(-"+c+"px)":a+" rotateX(90deg) translateZ(-"+c+"px)"}function k(a,b){db.apply(this);eb.apply(this);this._containerDom=a;this._heading=this._svid=this._eventDetector=this._canvas=this._sceneMask=this._sceneContainer=this._panoContainer=null;this._pitch=0;this._minPitch=this.DEFAULT_MIN_PITCH;this._maxPitch=this.DEFAULT_MAX_PITCH;this._zoom=1;this._panoCore=null;this._baseFovy=b.fovy||sa.defaultFovY;ja&&console.log("api options:",b);this._options={pf:b.pf,from:b.from,ch:b.ch,draggable:!1===b.draggable?!1:!0,canMove:!1===b.canMove?!1:!0,gyro:!1===b.gyro?!1:!0,hasLogo:!1===b.hasLogo?!1:!0,key:b.key||""};this.data={geoPos:{x:null,y:null},cameraHeight:2.3,cameraDir:0,address:null,scenicId:null};this._cachedData={};this._geoToWorldMatrix=new Hb;this._viewWidth=a.clientWidth;this._viewHeight=a.clientHeight;this.stopOverlayChanged=!1;this.isOverlayVisible=!0;this.isForceRefresh=!1;this._model=null;this._onSvDataLoaded=P.bindThis(this._onSvDataLoaded,this);Ia.android&&(this.MAX_ZOOM=3);this._buildContainer();var c=Object.create(sa);if(b)for(var d in b)c[d]=b[d];b=c;b.fovy=this._baseFovy;b.viewWidth=this._viewWidth;b.viewHeight=this._viewHeight;Ia.supportsCSS3()&&"dom"!==b.renderer?this._panoCore=new Ib(this._sceneContainer,b):(b.preload=Ia.isQQBrowser4(),this._panoCore=new Jb(this._sceneContainer,b));this.setHeading(b.heading);this.setPitch(b.pitch);this.setZoom(b.zoom);b.svid&&this.setSvid(b.svid);this.markers={length:0,content:{}};var e=this;this.addListener("render",function(){e.refreshMarkersPosition()});b.svid&&this.setSvid(b.svid);this.scene=new Kb(this,this._canvas);this._panoCore.get3DOverlays&&this.scene.addObject3D(this._panoCore.get3DOverlays());this.stopOverlayChanged=!1;this._initPanoListeners();Lb(this,this._options)}function Lb(a,b){b.draggable&&Mb.create().addToPano(a);b.canMove&&Nb.create().addToPano(a);b.canMove&&Ob.create().addToPano(a)}function Pb(){var a=document.createElement("div"),b=a.style;b.position="absolute";b.width=0;b.height=0;return a}function Ja(a,b){return function(){a.apply(b,arguments)}}function $(a,b){var c=Array.prototype.slice.call(arguments,2);return function(){a.apply(b,c)}}var z={TILE_WIDTH:256,TILE_HEIGHT:256,COL_COUNT:8,ROW_COUNT:4};z.TILES_WIDTH=z.TILE_WIDTH*z.COL_COUNT;z.TILES_HEIGHT=z.TILE_HEIGHT*z.ROW_COUNT;z.FADE_TIME=1e3;z.FADE_FRAME_COUNT=40;z.BEGIN_HEADING=180;z.debug=!1;var ma=z;Aa.prototype.fadeIn=function(a){Ra(a,0,100)};Aa.prototype.fadeOut=function(a){Ra(a,100,0)};var O=window.navigator.userAgent,B={android:/android\s(\d+\.\d)/i.test(O)?+RegExp.$1:0,ios:/iPad|iPod|iPhone/i.test(O),iphone:/iPhone\sOS\s(\d[_\d]*)/i.test(O)?+parseFloat(RegExp.$1.replace(/_/g,".")):0,ipad:/iPad.*OS\s(\d[_\d]*)/i.test(O)?+parseFloat(RegExp.$1.replace(/_/g,".")):0,ipod:/iPod\sOS\s(\d[_\d]*)/i.test(O)?+parseFloat(RegExp.$1.replace(/_/g,".")):0,mqqBrowser:/MQQBrowser\/(\d+)/i.test(O)?+parseFloat(RegExp.$1):0,uc:/UC/i.test(O)||/UCWEB/i.test(window.navigator.vendor),micromessenger:/MicroMessenger/i.test(O),i9300:/i9300/i.test(O),sonyEricssonLT26i:/sonyEricssonLT26i/i.test(O),google:/google/i.test(window.navigator.vendor),iosQQ:/(iPad|iPhone|iPod).*?QQ/g.test(O),androidQQ:/\bV1_AND_SQ_/.test(O)};B.mobileQQ=B.iosQQ||B.androidQQ;B.mqq=B.mqqBrowser;B.isQQBrowser4=function(){return null!=navigator&&0<=navigator.userAgent.indexOf("MQQBrowser/4.0")};B.supportsCSS3=function(){return B.sonyEricssonLT26i||B.i9300?!1:B.ios&&!B.uc||4<=B.android&&B.google&&!B.mqq&&!B.uc};(function(){if(B.i9300){var a=Math.sin,b=Math.cos;Math.sin=function(b){return b?a(b):0};Math.cos=function(a){return a?b(a):1}}})();C.prototype.add=function(a){return new C(this.x+a.x,this.y+a.y)};C.prototype.subtract=function(a){return new C(this.x-a.x,this.y-a.y)};C.prototype.dotProduct=function(a){return this.x*a.x+this.y*a.y};C.prototype.crossProduct=function(a){return this.x*a.y-this.y*a.x};C.prototype.length=function(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))};C.prototype.equals=function(a){return this.x==a.x&&this.y==a.y};C.prototype.clone=function(){return new C(this.x,this.y)};C.prototype.normalize=function(a){var b=this.length();a?(this.x*=a,this.y*=a):b&&(this.x/=b,this.y/=b)};C.prototype.offset=function(a,b){this.x+=a;this.y+=b};C.prototype.toString=function(){return[this.x,this.y].join()};C.polar=function(a,b){return new C(a*Math.cos(b),a*Math.sin(b))};C.distance=function(a,b){return b.subtract(a).length()};C.interpolate=function(a,b,c){if(0==c)return b;if(1==c)return a;a=a.subtract(b);a.normalize(c);return a.add(b)};C.toString=function(){return"("+this.x+","+this.y+")"};var aa=C;Ta(location.search&&location.search.substr(1));var ta=Ta(location.hash&&location.hash.substr(1)),T={tileDomain:"http://sv${x}.map.qq.com/tile",thumbDomain:"http://sv1.map.qq.com/thumb",test_tileDomain:"http://test.sv${x}.map.qq.com/tile",test_thumbDomain:"http://test.sv1.map.qq.com/thumb",test_xmlDomain:"http://test.sv.map.qq.com",admin_tileDomain:"http://admin.sv${x}.map.qq.com/tile",admin_thumbDomain:"http://admin.sv1.map.qq.com/thumb",admin_xmlDomain:"http://admin.sv.map.qq.com",blank:"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAQAIBRAA7",streetTileDomain:"http://sv0.map.qq.com/road/",placeSearch:"http://apis.map.qq.com",placeSearchKey:"HGWBZ-A6SRV-TWHPL-UG2TZ-WSB2S-ZRFTQ",CDNPath:"http://s.map.qq.com/kepler/",uvStatUidKey:"QQMapKeplerUid4UV",poidetailPage:"http://mp.weixin.qq.com/mp/lifedetail?bid=dianping_{dpId}#wechat_redirect",poidetailList:"http://a.map.gtimg.com",statAPPName:"h5streetview"};if(window.__keplerDevConfig)for(var fb in __keplerDevConfig)T[fb]=__keplerDevConfig[fb];T.getImgUrl=function(a){return T.CDNPath+a};T.getResPath=function(a){return T.CDNPath+a};var Qb={areaOfTriangle:ga,pointInTriangle:Ua,intersectPlane:Va,intersectTriangle:function(a,b,c,d,e){var f=d,g=e,h=f.x-c.x,n=f.y-c.y,f=f.z-c.z,q=g.x-c.x,s=g.y-c.y,g=g.z-c.z;return(a=Va(a,b,c,{x:n*g-f*s,y:-(h*g-f*q),z:h*s-n*q}))&&Ua(a,c,d,e)?a:null}};l.prototype.clone=function(){return new l(this.x,this.y,this.z)};l.prototype.equals=function(a){return.001<=Math.abs(this.x-a.x)&&.001<=Math.abs(this.y-a.y)&&.001<=Math.abs(this.z-a.z)};l.prototype.add=function(a){return new l(this.x+a.x,this.y+a.y,this.z+a.z,0)};l.prototype.subtract=function(a){return new l(this.x-a.x,this.y-a.y,this.z-a.z,0)};l.prototype.dotProduct=function(a){return this.x*a.x+this.y*a.y+this.z*a.z};l.prototype.crossProduct=function(a){var b=new l;b.x=this.y*a.z-this.z*a.y;b.y=this.z*a.x-this.x*a.z;b.z=this.x*a.y-this.y*a.x;b.w=1;return b};l.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};l.prototype.incrementBy=function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z};l.prototype.project=function(){0!=this.w&&(this.x/=this.w,this.y/=this.w,this.z/=this.w,this.w=1)};l.prototype.normalize=function(){var a=this.length();0!=a&&(this.x/=a,this.y/=a,this.z/=a)};l.prototype.scaleBy=function(a){this.x*=a;this.y*=a;this.z*=a};l.prototype.toString=function(){return[this.x,this.y,this.z,this.w].join()};l.prototype.negate=function(){this.x=-this.x;this.y=-this.y;this.z=-this.z};l.distance=function(a,b){};l.angleBetween=function(a,b){};var m={hashFilter:function(a){var b=/(\?[^$]+)/i.test(a)?RegExp.$1:"";return a.replace(b,"").replace(/[?]?isappinstalled=\d/i,"").replace(/[?]?from=[^&]+[&]?]/i,"")}};(function(){var a=Object.prototype,b=a.toString,c=a.hasOwnProperty;m.isArray=function(a){return"[object Array]"===b.call(a)};m.isNodeList=function(a){return"[object NodeList]"===b.call(a)};m.isObject=function(a){return"[object Object]"===b.call(a)};m.isNumber=function(a){return"[object Number]"===b.call(a)};var d=m.each=function(a,b){if(m.isArray(a)||m.isNodeList(a))for(var d=0,e=a.length;d<e;d++)b.call(a,a[d],d);else if(m.isObject(a))for(d in a)c.call(a,d)&&b.call(a,a[d],d);else if(m.isNumber(a))for(d=0,e=a;d<e;d++)b(d,a)},e={},f=/-(\w)/g,g=function(a,b,c){return 0==c?b:b.toUpperCase()},h=function(a,b){var c=[];d(b,function(a,b){c.push(b+":"+a)});a.style.cssText=c.join(";")};m.createElem=function(a,b){var c=document.createElement(a);h(c,b,!0);return c};m.setStyles=function(a,b){d(b,function(b,c){var d=a.style,h;e[c]?h=e[c]:(h=c.replace(f,g),e[c]=h);d[h]=b})}})();m.toCoreHeading=function(a,b){a=parseFloat(a);if(!isNaN(a)&&!isNaN(parseFloat(b))){if(360<a||-360>a)a%=360;0>a&&(a=360+a);return a>=b?a-b:a+360-b}};m.toCorePitch=function(a){a=parseFloat(a);if(!isNaN(a))return a=Math.max(a,-90),Math.min(a,90)};m.getWorldPosition=function(a,b,c){a=a*Math.PI/180;b=b*Math.PI/180;a={x:Math.cos(b)*Math.sin(a),y:Math.sin(b),z:Math.cos(b)*Math.cos(a)};c/=2;c=[[{x:c,y:c,z:-c},{x:c,y:-c,z:-c},{x:-c,y:c,z:-c}],[{x:-c,y:-c,z:-c},{x:c,y:-c,z:-c},{x:-c,y:c,z:-c}],[{x:c,y:c,z:-c},{x:c,y:-c,z:-c},{x:c,y:c,z:c}],[{x:c,y:-c,z:-c},{x:c,y:-c,z:c},{x:c,y:c,z:c}],[{x:c,y:c,z:c},{x:c,y:-c,z:c},{x:-c,y:-c,z:c}],[{x:c,y:c,z:c},{x:-c,y:-c,z:c},{x:-c,y:c,z:c}],[{x:-c,y:c,z:c},{x:-c,y:c,z:-c},{x:-c,y:-c,z:-c}],[{x:-c,y:c,z:c},{x:-c,y:-c,z:c},{x:-c,y:-c,z:-c}],[{x:-c,y:c,z:-c},{x:c,y:c,z:-c},{x:c,y:c,z:c}],[{x:-c,y:c,z:-c},{x:-c,y:c,z:c},{x:c,y:c,z:c}],[{x:-c,y:-c,z:-c},{x:c,y:-c,z:-c},{x:c,y:-c,z:c}],[{x:-c,y:-c,z:-c},{x:-c,y:-c,z:c},{x:c,y:-c,z:c}]];for(b=0;b<c.length;b++){var d=c[b];if(d=Qb.intersectTriangle({x:0,y:0,z:0},a,d[0],d[1],d[2]))return new l(d.x,d.y,-d.z,1)}};(function(){window.__KeplerJsonpCbHolder={};var a=0;m.loadJsonp=function(b,c){var f="_"+a++,g=document.createElement("script");document.body.appendChild(g);g.src=b+"&output=jsonp&cb=__KeplerJsonpCbHolder."+f;window.__KeplerJsonpCbHolder[f]=function(a){c&&c(a);document.body.removeChild(g);delete window.__KeplerJsonpCbHolder[f];f=c=g=null}};var b,c;b={};m.getPanoInfo=function(a,c){if(b["s_"+a])setTimeout(function(){c(b["s_"+a])},0);else{var f=T.uvStatUidKey,g=m.getCookie(f);g||(g=(new Date).getUTCMilliseconds(),g=Math.round(2147483647*Math.random())*g%1e10,document.cookie=f+"="+g+";path=/; expires=Sun, 18 Jan 2038 00:00:00 GMT;");f=T.xmlDomain+"/sv?svid="+a+"&pf=html5&suid="+g;(g=ta.ref)&&(f+="&from="+g);(g=ta.ch||g)&&(f+="&ch="+g);m.loadJsonp(f,function(f){b["s_"+a]=f;c(f)})}};m.getXfPanoInfo=function(a,b,c,g,h){m.loadJsonp("http://sv.map.qq.com/xf?x="+b+"&y="+c+"&r="+g+"&target=1&uid="+a,h)};c={};m.getAddress=function(a,b,f){c.lat==a&&c.lng==b?setTimeout(function(){f&&f(c.address)},0):m.loadJsonp("http://sv.map.qq.com/rarp?lat="+a+"&lng="+b,function(g){0==g.info.errno&&(c={lat:a,lng:b,address:g.detail.AD},f&&f(g.detail.AD))})};m.getPoi3D=function(a,b,c,g,h){m.loadJsonp("http://sv.map.qq.com/poi3d?x="+a+"&y="+b+"&source="+c+"&type="+g+"&output=jsonp",h)}})();(function(){function a(a,c){var d=new XMLHttpRequest;d.open("GET",a,!0);d.onload=function(){var a=JSON.parse(this.response);c(a);console.log("xhr:",this)};d.onerror=function(){console.error("xhr:",this);0==this.status&&console.error("\u672a\u627e\u5230\u670d\u52a1\uff01");c(null,"Net error")};d.send()}m.getPOIDetail=function(b,c,d,e){a(T.poidetailList+"/poi/list/?x="+b+"&y="+c+"&type="+d,e)}})();m.getCookie=function(a){a=document.cookie.match(RegExp("(^| )"+a+"=([^;]*)(;|$)"));return null!=a?a[2]:null};m.report=function(a,b,c,d){c=document;var e=T.uvStatUidKey;(d=m.getCookie(e))||(d=(new Date).getUTCMilliseconds(),d=Math.round(2147483647*Math.random())*d%1e10,c.cookie=e+"="+d+";path=/; expires=Sun, 18 Jan 2038 00:00:00 GMT;");var e=m.getCookie("session_id")||"",f=window.__pn||0,g=window.__resultPos||0,h=window.__tagId||0,n=[];a&&(n=a.split("_"),n[3]&&(a=n.slice(0,4).join("_")));var q=n[0]||"",s=n[1]||"",t=n[2]||"",w=n[3]||"",E=n[4]||"",n=n[5]||"";(new Image(1,1)).src="http://pr.map.qq.com/pingd?srctype=getsret&lurl="+escape(c.location)+"&ourl="+escape(a)+"&suid="+d+"&session_id="+e+"&search_id="+w+"&unc="+n+"&keyword="+s+"&city="+t+"&ch="+b+"&sort="+q+"&subloc="+E+"&result_pos="+g+"&sc=map&pg="+f+"&tagId="+h+"&rand="+Math.random()};m.sudoReport=function(a,b,c,d){var e=new Image(1,1),f;3==arguments.length?f="?add="+a+"|"+b+"|"+(c||1):4==arguments.length&&(f="?add="+a+"|"+b+"|"+c+"|"+(d||1));e.src="http://ping.map.qq.com/stat"+f};m.report3=function(a,b){var c=ta.ch||ta.ref||"",d=B.android?"android":B.ios?"ios":"",e;(e=(e=document.cookie.match(/suid=[^;]*/))&&0<e.length?e[0].split("=")[1]:null)||(e=(new Date).getUTCMilliseconds(),e=Math.round(2147483647*Math.random())*e%1e10,document.cookie="suid="+e+";path=/; expires=Sun, 18 Jan 2038 00:00:00 GMT;");(new Image(1,1)).src="http://pr.map.qq.com/pingd?appid="+a+"&suid="+e+"&logid="+b+"&rand="+Math.random()+"&app="+T.statAPPName+"&ch="+c+"&pf="+d};m.getRandomID=function(a){var b=0;return function(){return"r_"+ ++b}}();m.report2=function(a){a="http://isdspeed.qq.com/cgi-bin/r.cgi?flag1=7804&flag2=8&flag3=4&1="+a;(new Image(1,1)).src=a};(function(){m.lngFrom4326ToProjection=function(a){return 111319.49077777778*a};m.latFrom4326ToProjection=function(a){a=Math.log(Math.tan(.008726646259971648*(90+a)))/.017453292519943295;return 111319.49077777778*a};m.lngFromProjectionTo4326=function(a){return a/111319.49077777778};m.latFromProjectionTo4326=function(a){return 114.59155902616465*Math.atan(Math.exp(a/111319.49077777778*.017453292519943295))-90}})();m.getPOV=function(a,b,c,d,e){null==e&&(e=2.3);var f=e-2.3,g=new aa(c-a,d-b);g.normalize();var h=new aa(0,1);e=180*Math.acos(g.dotProduct(h))/Math.PI;0<h.crossProduct(g)&&(e=360-e);a=Math.sqrt(Math.pow(c-a,2)+Math.pow(d-b,2));a=180*Math.atan(f/a)/Math.PI;return{heading:e,pitch:a}};m.setOpacity=function(a,b){a.style.opacity=b/100};m.bindThis=function(a,b){return function(){a.apply(b,arguments)}};m.inherits=function(a,b){a.super_=b;a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})};m.textWidth=function(a){if(a.nodeType){var b=a.style.position||"static",c;a.style.left="-9999px";a.style.position="absolute";document.body.appendChild(a);c=a.offsetWidth;a.style.position=b;document.body.removeChild(a);return c}};var ba={defaultFovY:100,svDataUrl:"http://sv.map.qq.com",tileDomain:"http://sv${x}.map.qq.com/tile",thumbDomain:"http://sv1.map.qq.com/thumb",xmlDomain:"http://sv.map.qq.com",blank:"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAQAIBRAA7",logo:"http://s.map.qq.com/kepler/images/mapLogo3.png"},sb=ba;Y.prototype.setViewSize=function(a,b){this.img.style.width=a+"px";this.img.style.height=b+"px"};Y.prototype.setPosition=function(a,b){this.img.style.left=a+"px";this.img.style.top=b+"px"};Y.prototype.loadThumb=function(a,b){this.img.src==a?b(!0):(this.img.onload=function(){b()},this.img.src=a)};Y.prototype.appendTo=function(a){a.appendChild(this.img)};Y.prototype.setVisibility=function(a){this.img.style.display=a?"":"none"};Y.prototype.setAlpha=function(a){m.setOpacity(this.img,a)};K.prototype.intersects=function(a){return this.x>a.x+a.width||this.x+this.width<a.x||this.y>a.y+a.height||this.y+this.height<a.y?!1:!0};K.prototype.contains=function(a){return a.x>=this.x&&a.x<=this.x+this.width&&a.y>=this.y&&a.y<=this.y+this.height};K.prototype.toString=function(){return"[x="+this.x+",y="+this.y+",width="+this.width+",height="+this.height+"]"};K.prototype.getClassName=function(){return"Rectangle"};var tb=K,vb=ba,na=z.TILE_WIDTH,oa=z.TILE_HEIGHT;V.prototype.setViewSize=function(a,b){this.img.style.width=a+"px";this.img.style.height=b+"px"};V.prototype.setPosition=function(a,b){var c=this.img.style;c.left=a+"px";c.top=b+"px";z.debug&&(this.img.style.border="1px solid",this.label.style.left=a+na/2+"px",this.label.style.top=b+oa/2+"px")};V.prototype.loadTile=function(a,b){if(this.imgSrc!=a){var c=this.img;this.img.onload=function(){c.style.zIndex=3;b()};this.img.src=this.imgSrc=a}};V.prototype.appendTo=function(a){a.appendChild(this.img);z.debug&&a.appendChild(this.label)};V.prototype.getBounds=function(){return this.bounds};V.prototype.setVisibility=function(a){this.visibility!=a&&(this.visibility=a,this.img.style.display=this.label.style.display=a?"":"none")};V.prototype.isVisible=function(){return"none"!=this.img.style.display};V.prototype.setAlpha=function(a){m.setOpacity(this.img,a)};H.prototype.addListener=function(a,b){if("function"!=typeof b)throw TypeError("Event Listener must be function");var c=this._listeners[a]||[];this._listeners[a]=c;c.push(b);c.length>this.maxListeners&&console.warn(a,"Listeners for ",this,"is",c.length,". May cause memory problem");return this};H.prototype.on=H.prototype.addListener;H.prototype.removeListener=function(a,b){var c=this._listeners[a]||[],d=c.indexOf(b);-1<d&&(c[d]=null)};H.prototype.dispatchEvent=function(a,b,c){c=c||this;var d=c._listeners[a];if(d)for(var e=0,f=d.length;e<f;e++)d[e]&&d[e].call(c,{type:a,data:b})};H.prototype.dispatchAsyncEvent=function(a,b){setTimeout(this.dispatchEvent,0,a,b,this)};H.prototype._cleanNullListeners=function(a,b){b=b||this;for(var c=b[a],d=[],e=0;e<c.length;e++)c[e]&&d.push(c[e]);b[a]=d};H.prototype.clearListeners=function(){this._listeners={}};var ka=Wa.prototype;ka.append=function(a){this.pool.push(a)};ka.remove=function(a){for(var b=0,c=-1;b<this.pool.length;b++)this.pool[b]==a&&(c=b);-1<c&&this.pool.splice(c,1)};ka.bindEvent=function(a){a=a||this.canvas;for(var b=this;this.bindEvents[0];){var c=this.bindEvents.pop();a.addEventListener(c,function(a){return function(c){b.check(c,a)}}(c),!1)}};ka.check=function(a,b){for(var c=this.pool.length-1;0<=c;c--){var d=this.pool[c];if(this.isInside(a,this.pool[c].eventPolygon)&&d.dispatchEvent){d.dispatchEvent(b,{evt:a});break}}};ka.isInside=function(a,b){var c=!1,d,e;a.changedTouches?(e=a.changedTouches[0],window.webkitConvertPointFromPageToNode?(d=this.canvas,e=new WebKitPoint(e.pageX,e.pageY),e=webkitConvertPointFromPageToNode(d,e),d=e.x,e=e.y):(d=e.pageX,e=e.pageY)):(d=a.offsetX||a.pageX,e=a.offsetY||a.pageY);if(b){this.canvas.getContext("2d");for(var f=-1,g=b.length,h=g-1;++f<g;h=f)(b[f][1]<=e&&e<b[h][1]||b[h][1]<=e&&e<b[f][1])&&d<(b[h][0]-b[f][0])*(e-b[f][1])/(b[h][1]-b[f][1])+b[f][0]&&(c=!c)}return c};var gb,Ka={getInstance:function(a,b){return gb||(gb=new Wa(a,b))}};Z.prototype.equal=function(a){return this==a||.001>Math.abs(this.v[0]-a.v[0])&&.001>Math.abs(this.v[1]-a.v[1])&&.001>Math.abs(this.v[2]-a.v[2])&&.001>Math.abs(this.v[3]-a.v[3])};Z.prototype.dotProduct=function(a){return this.v[0]*a.v[0]+this.v[1]*a.v[1]+this.v[2]*a.v[2]+this.v[3]*a.v[3]};Z.prototype.identity=function(){this.v[0]=0;this.v[1]=0;this.v[2]=0;this.v[3]=1};Z.prototype.length=function(){var a=this.v[0],b=this.v[1],c=this.v[2],d=this.v[3];return Math.sqrt(a*a+b*b+c*c+d*d)};Z.prototype.toMatrix3D=function(){var a=[],b=this.v[0],c=this.v[1],d=this.v[2],e=this.v[3],f=b+b,g=c+c,h=d+d,n=b*f,q=b*g,b=b*h,s=c*g,c=c*h,d=d*h,f=e*f,g=e*g,e=e*h;a[0]=1-(s+d);a[1]=q+e;a[2]=b-g;a[3]=0;a[4]=q-e;a[5]=1-(n+d);a[6]=c+f;a[7]=0;a[8]=b+g;a[9]=c-f;a[10]=1-(n+s);a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a};Z.prototype.toString=function(){return this.v.join(",")};x.prototype.clone=function(){for(var a=[],b=this.v.length-1;0<=b;b--)a[b]=this.v[b];return new x(a)};x.prototype.identity=function(){for(var a=0;16>a;a++)this.v[a]=0==a||5==a||10==a||15==a?1:0};x.prototype.equal=function(a){for(var b=0;16>b;b++)if(.01<=Math.abs(this.v[b]-a.v[b]))return!1;return!0};x.prototype.determinant=function(){var a=this.v[0],b=this.v[1],c=this.v[2],d=this.v[3],e=this.v[4],f=this.v[5],g=this.v[6],h=this.v[7],n=this.v[8],q=this.v[9],s=this.v[10],t=this.v[11],w=this.v[12],E=this.v[13],L=this.v[14],k=this.v[15];return w*q*g*d-n*E*g*d-w*f*s*d+e*E*s*d+n*f*L*d-e*q*L*d-w*q*c*h+n*E*c*h+w*b*s*h-a*E*s*h-n*b*L*h+a*q*L*h+w*f*c*t-e*E*c*t-w*b*g*t+a*E*g*t+e*b*L*t-a*f*L*t-n*f*c*k+e*q*c*k+n*b*g*k-a*q*g*k-e*b*s*k+a*f*s*k};x.prototype.invert=function(){var a=this.v[0],b=this.v[1],c=this.v[2],d=this.v[3],e=this.v[4],f=this.v[5],g=this.v[6],h=this.v[7],n=this.v[8],q=this.v[9],s=this.v[10],t=this.v[11],w=this.v[12],E=this.v[13],L=this.v[14],k=this.v[15],r=a*f-b*e,u=a*g-c*e,m=a*h-d*e,v=b*g-c*f,l=b*h-d*f,p=c*h-d*g,x=n*E-q*w,z=n*L-s*w,A=n*k-t*w,B=q*L-s*E,C=q*k-t*E,D=s*k-t*L,y=r*D-u*C+m*B+v*A-l*z+p*x;y&&(this.v[0]=(f*D-g*C+h*B)/y,this.v[1]=(-b*D+c*C-d*B)/y,this.v[2]=(E*p-L*l+k*v)/y,this.v[3]=(-q*p+s*l-t*v)/y,this.v[4]=(-e*D+g*A-h*z)/y,this.v[5]=(a*D-c*A+d*z)/y,this.v[6]=(-w*p+L*m-k*u)/y,this.v[7]=(n*p-s*m+t*u)/y,this.v[8]=(e*C-f*A+h*x)/y,this.v[9]=(-a*C+b*A-d*x)/y,this.v[10]=(w*l-E*m+k*r)/y,this.v[11]=(-n*l+q*m-t*r)/y,this.v[12]=(-e*B+f*z-g*x)/y,this.v[13]=(a*B-b*z+c*x)/y,this.v[14]=(-w*v+E*u-L*r)/y,this.v[15]=(n*v-q*u+s*r)/y)};x.prototype.transpose=function(){var a=this.v[1],b=this.v[2],c=this.v[3],d=this.v[6],e=this.v[7],f=this.v[11];this.v[1]=this.v[4];this.v[2]=this.v[8];this.v[3]=this.v[12];this.v[4]=a;this.v[6]=this.v[9];this.v[7]=this.v[13];this.v[8]=b;this.v[9]=d;this.v[11]=this.v[14];this.v[12]=c;this.v[13]=e;this.v[14]=f};x.prototype.append=function(a){var b=a.v[0],c=a.v[1],d=a.v[2],e=a.v[3],f=a.v[4],g=a.v[5],h=a.v[6],n=a.v[7],q=a.v[8],s=a.v[9],t=a.v[10],w=a.v[11],E=a.v[12],k=a.v[13],m=a.v[14];a=a.v[15];var r=this.v[0],u=this.v[4],l=this.v[8],v=this.v[12];this.v[0]=r*b+u*c+l*d+v*e;this.v[4]=r*f+u*g+l*h+v*n;this.v[8]=r*q+u*s+l*t+v*w;this.v[12]=r*E+u*k+l*m+v*a;r=this.v[1];u=this.v[5];l=this.v[9];v=this.v[13];this.v[1]=r*b+u*c+l*d+v*e;this.v[5]=r*f+u*g+l*h+v*n;this.v[9]=r*q+u*s+l*t+v*w;this.v[13]=r*E+u*k+l*m+v*a;r=this.v[2];u=this.v[6];l=this.v[10];v=this.v[14];this.v[2]=r*b+u*c+l*d+v*e;this.v[6]=r*f+u*g+l*h+v*n;this.v[10]=r*q+u*s+l*t+v*w;this.v[14]=r*E+u*k+l*m+v*a;r=this.v[3];u=this.v[7];l=this.v[11];v=this.v[15];this.v[3]=r*b+u*c+l*d+v*e;this.v[7]=r*f+u*g+l*h+v*n;this.v[11]=r*q+u*s+l*t+v*w;this.v[15]=r*E+u*k+l*m+v*a};x.prototype.prepend=function(a){var b=a.v[0],c=a.v[1],d=a.v[2],e=a.v[3],f=a.v[4],g=a.v[5],h=a.v[6],n=a.v[7],q=a.v[8],s=a.v[9],t=a.v[10],w=a.v[11],l=a.v[12],k=a.v[13],m=a.v[14];a=a.v[15];var r=this.v[0],u=this.v[1],p=this.v[2],v=this.v[3];this.v[0]=b*r+f*u+q*p+l*v;this.v[1]=c*r+g*u+s*p+k*v;this.v[2]=d*r+h*u+t*p+m*v;this.v[3]=e*r+n*u+w*p+a*v;r=this.v[4];u=this.v[5];p=this.v[6];v=this.v[7];this.v[4]=b*r+f*u+q*p+l*v;this.v[5]=c*r+g*u+s*p+k*v;this.v[6]=d*r+h*u+t*p+m*v;this.v[7]=e*r+n*u+w*p+a*v;r=this.v[8];u=this.v[9];p=this.v[10];v=this.v[11];this.v[8]=b*r+f*u+q*p+l*v;this.v[9]=c*r+g*u+s*p+k*v;this.v[10]=d*r+h*u+t*p+m*v;this.v[11]=e*r+n*u+w*p+a*v;r=this.v[12];u=this.v[13];p=this.v[14];v=this.v[15];this.v[12]=b*r+f*u+q*p+l*v;this.v[13]=c*r+g*u+s*p+k*v;this.v[14]=d*r+h*u+t*p+m*v;this.v[15]=e*r+n*u+w*p+a*v};x.prototype.transformVector=function(a){var b=a.x,c=a.y;a=a.z;return new l(this.v[0]*b+this.v[4]*c+this.v[8]*a+this.v[12],this.v[1]*b+this.v[5]*c+this.v[9]*a+this.v[13],this.v[2]*b+this.v[6]*c+this.v[10]*a+this.v[14],this.v[3]*b+this.v[7]*c+this.v[11]*a+this.v[15])};x.prototype.transformVectors=function(a){for(var b=a.length,c=[],d=0;d<b;d++)c.push(this.transformVector(a[d]));return c};x.prototype.appendTranslate=function(a,b,c){var d,e,f,g,h,n,q,s,t,w,l,k;d=this.v[0];e=this.v[1];f=this.v[2];g=this.v[3];h=this.v[4];n=this.v[5];q=this.v[6];s=this.v[7];t=this.v[8];w=this.v[9];l=this.v[10];k=this.v[11];this.v[0]=d;this.v[1]=e;this.v[2]=f;this.v[3]=g;this.v[4]=h;this.v[5]=n;this.v[6]=q;this.v[7]=s;this.v[8]=t;this.v[9]=w;this.v[10]=l;this.v[11]=k;this.v[12]=d*a+h*b+t*c+this.v[12];this.v[13]=e*a+n*b+w*c+this.v[13];this.v[14]=f*a+q*b+l*c+this.v[14];this.v[15]=g*a+s*b+k*c+this.v[15]};x.prototype.appendScale=function(a,b,c){this.v[0]*=a;this.v[1]*=a;this.v[2]*=a;this.v[3]*=a;this.v[4]*=b;this.v[5]*=b;this.v[6]*=b;this.v[7]*=b;this.v[8]*=c;this.v[9]*=c;this.v[10]*=c;this.v[11]*=c};x.prototype.appendRotate=function(a,b){var c=Math.sin(a/2),d=c*b[0],e=c*b[1],c=c*b[2],f=Math.cos(a/2),d=(new Z([d,e,c,f])).toMatrix3D();this.append(new x(d))};x.prototype.interpolateTo=function(a,b){};x.interpolate=function(a,b,c){};x.prototype.toString=function(){return this.v.join(",")};x.prototype.glFrustum=function(a,b,c,d,e,f){var g=b-a,h=d-c,n=f-e;this.v[0]=2*e/g;this.v[1]=0;this.v[2]=0;this.v[3]=0;this.v[4]=0;this.v[5]=2*e/h;this.v[6]=0;this.v[7]=0;this.v[8]=(b+a)/g;this.v[9]=(d+c)/h;this.v[10]=-(f+e)/n;this.v[11]=-1;this.v[12]=0;this.v[13]=0;this.v[14]=-(f*e*2)/n;this.v[15]=0};x.prototype.glPerspective=function(a,b,c,d){a=c*Math.tan(a/2);var e=-a;this.glFrustum(e*b,a*b,e,a,c,d)};x.prototype.glLookAt=function(a,b,c){b=b.clone();b=b.subtract(a);b.normalize();b.w=0;c=c.clone();c=c.crossProduct(b);c.normalize();c.w=0;var d=b.clone(),d=d.crossProduct(c);d.w=0;var e=new l;e.x=c.dotProduct(a);e.y=d.dotProduct(a);e.z=b.dotProduct(a);e.w=1;this.v=[c.x,c.y,c.z,c.w,d.x,d.y,d.z,d.w,b.x,b.y,b.z,b.w,e.x,e.y,e.z,e.w]};x.prototype.glViewPort=function(a,b,c,d){this.v=[c/2,0,0,0,0,-d/2,0,0,0,0,1,0,c/2+a,d/2+b,0,1]};var ha=x,Xa=H;F.prototype=new Xa;F.prototype.addEventWatch=function(){Ka.getInstance().append(this)};F.prototype.removeEventWatch=function(){Ka.getInstance().remove(this)};F.prototype.getModelMatrix=function(){return this._modelMatrix};F.prototype.setModelMatrix=function(a){this._modelMatrix=a};F.prototype.translate=function(a,b,c){this._modelMatrix.appendTranslate(a,b,c)};F.prototype.translateSelf=function(a,b,c){var d=new ha;d.appendTranslate(a,b,c);this.vertices=d.transformVectors(this.vertices);this.eventCoords=d.transformVectors(this.eventCoords)};F.prototype.rotateSelf=function(a,b){var c=new ha;c.appendRotate(a,b);this.vertices=c.transformVectors(this.vertices);this.eventCoords=c.transformVectors(this.eventCoords)};F.prototype.scaleSelf=function(a,b,c){var d=new ha;d.appendScale(a,b,c);this.vertices=d.transformVectors(this.vertices);this.eventCoords=d.transformVectors(this.eventCoords)};F.prototype.scale=function(a,b,c){this._modelMatrix.appendScale(a,b,c)};F.prototype.rotate=function(a,b){this._modelMatrix.appendRotate(a,[b.x,b.y,b.z])};F.prototype.setTexture=function(a){this.texture.src=a};F.prototype.render=function(a){var b=a.canvas,c=a.camera,d=a.renderer,e=new ha;e.append(c.viewMatrix);e.append(this.getModelMatrix());d.render(b,this.vertices,this.indices,this.uvtData,this.texture,c.projectMatrix,e,a,this)};var ua=function(a,b){a.super_=b;a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})},y=[],Rb=0,La=function(a){H.apply(this);this._i=++Rb;y[this._i]={key:this._key,real:a}};ua(La,H);var G=La.prototype;G.getHeading=function(){return y[this._i].real.getHeading()};G.setHeading=function(a){y[this._i].real.setHeading(a)};G.getPitch=function(){return y[this._i].real.getPitch()};G.setPitch=function(a){y[this._i].real.setPitch(a)};G.getPano=function(){return y[this._i].real.getSvid()};G.setPano=function(a){y[this._i].real.setSvid(a)};G.getPov=function(){var a=y[this._i].real.getHeading(),b=y[this._i].real.getPitch();return{heading:a,pitch:b}};G.setPov=function(a){if("object"!==typeof a||null===a||isNaN(a.heading)||isNaN(a.pitch))throw Error("Parameter is not valid. by:setPov()");var b=a.pitch;y[this._i].real.setHeading(a.heading);y[this._i].real.setPitch(b)};G.setZoom=function(a){y[this._i].real.setZoom(a)};G.getZoom=function(){return y[this._i].real.getZoom()};G.getVisible=function(){return y[this._i].real.getVisible()};G.setVisible=function(a){if("boolean"!==typeof a)throw Error("Parameter is not valid. by:setVisible()");y[this._i].real.setVisible(a)};G.getPosition=function(){return y[this._i].real.getPosition()};G._proxyOf=function(a){return y[this._i]===a};G.destroy=function(){y[this._i]=null};var G=null,da=function(){this._container=this._pano=null};da.prototype.addToPano=function(a){};da.prototype.removefromPano=function(){};da.prototype.getPano=function(){return this._pano};da.prototype.getContainer=function(){if(null===this._container){var a=document.createElement("div");a.style.position="absolute";a.style.width=0;a.style.height=0;this._container=a;null!==this._pano&&y[this._pano._i]._panoContainer.appendChild(a)}return this._container};da.prototype.NAME="PanoPlugin";B.ios||B.chrome||B.uc?pa.prototype.preRender=function(){this._2dContext.clearRect(0,0,this.canvas.width,this.canvas.height)}:(console.warn("Fix android duplicate arrow bug."),pa.prototype.preRender=function(){this._2dContext.clearRect(0,0,this.canvas.width,this.canvas.height);this.canvas.width+=1;this.canvas.width-=1});pa.prototype.render=function(a,b,c,d,e,f,g,h,n){if(n.fixMatrix)for(e=n.fixMatrix,a=0,d=e.length;a<d;a++)g.prepend(e[a]);g.prepend(f);e=g.clone();d=[];f=[];var q=n.eventCoords||[];g=n.renderOptions||{};n.screenCoords=[];var s=b.length;a=0;for(var t;a<s;a++)t=e.transformVector(b[a]),t.project(),d.push(t);a=h.clip(d,c);if(0!=a.length){for(a=0;a<s;a++)t=d[a],t=h.viewPortMatrix.transformVector(t),f.push(t.x,t.y),n.screenCoords.push(t);b=[];a=0;for(d=q.length;a<d;a++)t=e.transformVector(q[a]),t.project(),t=h.viewPortMatrix.transformVector(t),b.push([t.x,t.y]);n.eventPolygon=b;h=this._2dContext;h.beginPath();h.strokeStyle=g.strokeStyle||"#000000";h.lineWidth="2";h.fillStyle=g.fillStyle||"#ffffff";b=f[0];c=f[1];h.moveTo(b,c);a=1;for(d=f.length/2-(n.extraVerticeNum||0);a<d;a++)b=f[2*a],c=f[2*a+1],h.lineTo(b,c);h.closePath();h.stroke();h.fill()}};var Ca=F,va,hb,Ma;M.prototype=new Ca;M.prototype.constructor=M;M.prototype.createLabel=function(){this.labelDom=document.createElement("div");var a=this.labelDom.style;a.position="absolute";a.top=0;a.left=0;a.whiteSpace="nowrap";a.fontSize="13px";a.visibility="hidden";a.zIndex=9};M.prototype.setLabel=function(a){this.labelDom.textContent=a};M.prototype._setLabelPos=function(a){var b=this.labelDom;a?(b.style.visibility="visible",b.style.webkitTransform="translate("+(a.x-b.offsetWidth/2)+"px, "+(a.y-b.offsetHeight/2)+"px)"):b.style.visibility="hidden"};M.prototype.build=function(){this.vertices[0]=new l(0,0,100);this.vertices[1]=new l(3,0,99);this.vertices[2]=new l(55,0,42);this.vertices[3]=new l(56,0,39);this.vertices[4]=new l(55,0,37);this.vertices[5]=new l(52,0,36);this.vertices[6]=new l(30,0,36);this.vertices[7]=new l(30,0,3);this.vertices[8]=new l(29,0,1);this.vertices[9]=new l(27,0,0);this.vertices[10]=new l(-27,0,0);this.vertices[11]=new l(-29,0,1);this.vertices[12]=new l(-30,0,3);this.vertices[13]=new l(-30,0,36);this.vertices[14]=new l(-52,0,36);this.vertices[15]=new l(-55,0,37);this.vertices[16]=new l(-56,0,39);this.vertices[17]=new l(-55,0,42);this.vertices[18]=new l(-3,0,99);this.labelVertexIndex=this.vertices.push(new l(0,0,51))-1;this.extraVerticeNum=1;this.eventCoords[0]=new l(60,0,0);this.eventCoords[1]=new l(60,0,100);this.eventCoords[2]=new l(-60,0,100);this.eventCoords[3]=new l(-60,0,0);this.indices[0]=0;this.indices[1]=1;this.indices[2]=2;this.indices[3]=2;this.indices[4]=3;this.indices[5]=4;this.indices[6]=2;this.indices[7]=4;this.indices[8]=5;this.indices[9]=5;this.indices[10]=6;this.indices[11]=0;this.indices[12]=0;this.indices[13]=2;this.indices[14]=5;this.scaleSelf(.01,1,.01);this.translateSelf(0,-4,.3)};M.prototype.render=function(a){var b=a.appParams;Ma=a;va=b.heading;hb=b.pitch;var b=this.getTranslatePos(3,50*Math.PI/180),c=new x;c.appendTranslate(b.x,b.y,b.z);this.setModelMatrix(c);b=15+15*Math.abs(Math.cos(va*Math.PI/180));c=new x;c.appendTranslate(0,0,-3);c.appendRotate(b*Math.PI/180,[1,0,0]);c.appendTranslate(0,0,3);this.fixMatrix[0]=c;this._super.render.apply(this,arguments);this._setLabelPos(this.screenCoords[this.labelVertexIndex])};M.prototype.getTranslatePos=function(a,b){var c=hb*Math.PI/180,d=Math.min(c,b),d=Math.max(c,-b),c=a*Math.cos(d)*Math.sin(-va*Math.PI/180),e=a*Math.sin(d),d=a*Math.cos(d)*Math.cos(-va*Math.PI/180);return new l(c,e,d)};M.prototype.reset=function(){(this.labelDom.parentNode||this.labelDom.parentElement)&&this.labelDom.parentNode.removeChild(this.labelDom);Ma&&Ma.removeObject3D(this)};M.prototype.removeListener=function(){this.clearListeners&&this.clearListeners();this.removeEventWatch&&this.removeEventWatch()};var Da=F,Ea=10;ia.prototype=new Da;ia.prototype.constructor=ia;ia.prototype.build=function(){for(var a=Ea,b=Ea,c=0,d=0,e=1/a,f=1/b,c=0;c<=a;c++)for(d=0;d<=b;d++)this.vertices.push(new l(e*c,0,f*d));for(c=0;c<a;c++)for(d=0;d<b;d++){var e=c*(b+1)+d,f=e+1,g=(c+1)*(b+1)+d,h=g+1;this.indices.push(e,f,g);this.indices.push(f,h,g)}for(c=0;c<this.vertices.length;c++)this.uvtData.push(this.vertices[c].x,this.vertices[c].z);this.translateSelf(0,-2,3)};ia.prototype.render=function(a){this._super.render.apply(this,arguments)};var Ya=x;qa.prototype.updateProjectMatrix=function(){this.projectMatrix.glPerspective(this.fovy,this.aspect,this.near,this.far)};qa.prototype.lookAt=function(a,b,c){this.eye=a;this.target=b;this.up=c;this.viewMatrix.glLookAt(a,b,c)};qa.prototype.lookAtTarget=function(a){this.target=a;this.viewMatrix.glLookAt(this.eye,a,this.up)};var Za=x;R.prototype.setCamera=function(a){this.camera=a};R.prototype.setRenderer=function(a){this.renderer=a};R.prototype.addObject3D=function(a){this.world.push(a)};R.prototype.removeObject3D=function(a){for(var b=this.world.length,c=0;c<b;c++)if(this.world[c]==a){this.world.splice(c,1);break}};R.prototype.clear=function(){this.world=[]};R.prototype.render=function(){this.renderer.preRender();for(var a=this.world.length,b=0;b<a;b++)this.renderObject3D(this.world[b])};R.prototype.renderObject3D=function(a){a.render(this)};R.prototype.clip=function(a,b){for(var c=[],d=b.length/3,e=0;e<d;e++){var f=b[3*e],g=b[3*e+1],h=b[3*e+2],n=a[f],q=a[g],s=a[h],t=n.x,w=n.y,n=n.z,l=q.x,k=q.y,q=q.z,m=s.x,r=s.y,s=s.z;(-1<=t&&1>=t&&-1<=w&&1>=w&&0<=n&&1>=n||-1<=l&&1>=l&&-1<=k&&1>=k&&0<=q&&1>=q||-1<=m&&1>=m&&-1<=r&&1>=r&&0<=s&&1>=s)&&c.push(f,g,h)}return c};R.prototype.viewPort=function(a,b,c,d){this.viewPortMatrix=new Za;this.viewPortMatrix.glViewPort(a,b,c,d);this.camera&&(this.camera.aspect=c/d,this.camera.updateProjectMatrix())};W.prototype.addSubRectangle=function(a){this.subRects.push(a)};W.prototype.getSubCount=function(){return this.subRects.length};W.prototype.getSubRectangle=function(a){return a>=this.subRects?null:this.subRects[a]};W.prototype.intersects=function(a){for(var b=0;b<this.subRects.length;b++)if(a.intersects(this.subRects[b]))return!0;return!1};W.prototype.toString=function(){for(var a="[",b=0;b<this.subRects.length;b++)a=a+this.subRects[b].toString()+",";return a+"]"};W.prototype.getClassName=function(){return"CompositeRectangle"};var Sb="0",ea={},ib=60,wa=0,xa=null,Na={init:function(){xa=window.setInterval(function(){Na.run((new Date).getTime())},1e3/ib)},run:function(a){var b,c;for(c in ea)b=ea[c],!0===b.handler(a-b.startTime)&&Na.remove(c);0==wa&&(clearInterval(xa),xa=null)},add:function(a,b,c){1==arguments.length&&(b=a,a=void 0);a=a||"R_"+(new Date).getTime().toString(32)+ ++Sb;0==wa&&null===xa&&this.init();ea[a]||wa++;ea[a]={startTime:(new Date).getTime(),handler:b};return a},remove:function(a){ea[a]&&(delete ea[a],wa--)},getFPS:function(){},setMaxFPS:function(a){ib=a}},Oa=Na,wb=Aa,ya=z.COL_COUNT,jb=z.ROW_COUNT,Tb=z.TILE_WIDTH,Ub=z.TILE_HEIGHT;J.prototype.refresh=function(){var a=this._pano.getSvid(),b=this;if(a){if(this._lastSvid&&this._lastSvid!=a){this._isSvidChanged=!0;var c=this._currentTiles;this._currentTiles=this._lastTiles;this._lastTiles=c;c=this._currentThumbs;this._currentThumbs=this._lastThumbs;this._lastThumbs=c;this._fadeAnimation.fadeOut(this._lastTiles);setTimeout(function(){b._fadeAnimation.fadeIn(b._currentTiles)},0);this._fadeAnimation.fadeOut(this._lastThumbs);setTimeout(function(){b._fadeAnimation.fadeIn(b._currentThumbs)},0)}this._paint(this._currentTiles,this._currentThumbs);this._lastSvid=a;this._isSvidChanged=!1}};J.prototype._paint=function(a,b){var c=this._pano.getSvid(),d=this._pano.getHeading(),e=this._pano.getPitch(),f=this._pano.getTileZoom(),g=this._pano.getBounds(),h=this._pano.getCompositeBounds(),n=this._pano.getCenter(),q=Tb*f,s=Ub*f;this._pano.isPreLoad();z.debug&&console.log("refresh heading="+d+" pitch="+e+" zoom="+f+" center="+n+" bounds="+g+" compositeBounds="+h);var d=this._getThumbURL(c),e=h.getSubCount(),n=this._getLoadTileCallback(e),g=h.getSubRectangle(0),t=-Math.floor(g.x*f),w=-Math.floor(g.y*f),l=b[0],k=b[1],m=z.TILES_WIDTH*f,r=z.TILES_HEIGHT*f;l.setPosition(t,w);l.loadThumb(d,n);l.setVisibility(!0);l.setViewSize(m,r);2==e?(t=g.width*f,k.setPosition(t,w),k.loadThumb(d,n),k.setVisibility(!0),k.setViewSize(m,r)):k.setVisibility(!1);d=0;t=[];for(e=0;e<ya;e++)for(n=0;n<jb;n++)w=this._getTileIndex(e,n),w=a[w],l=this._isTileVisible(w,h),w.setVisibility(l),l&&(d++,t.push(w));n=this._getLoadTileCallback(d,"tile");h=0;for(e=t.length;h<e;h++)w=t[h],d=this._getTileURL(c,w.cidx,w.ridx),l=this._getTilePosition(w,g,f),w.loadTile(d,n),w.setViewSize(q,s),w.setPosition(l.x,l.y)};J.prototype._getLoadTileCallback=function(a,b){var c=this;if(!this._isSvidChanged)return function(){};var d=0,e,f;"tile"==b?(e="tileLoaded",f="tileLoading"):(e="thumbLoaded",f="thumbLoading");return function(){d++;d>=a&&c._pano.dispatchEvent(e);c._pano.dispatchEvent(f,{percent:d/a})}};J.prototype._isTileVisible=function(a,b){if(this._pano.isPreLoad())return!0;var c=a.getBounds();return b.intersects(c)};J.prototype._getTilePosition=function(a,b,c){var d=a.getBounds();a=d.x-b.x;b=d.y-b.y;a+z.TILE_WIDTH>z.TILES_WIDTH?a-=z.TILES_WIDTH:a<-z.TILE_WIDTH&&(a+=z.TILES_WIDTH);a=Math.floor(a*c);b=Math.floor(b*c);return new aa(a,b)};J.prototype._createTiles=function(a){this._tiles=this._createTiles0(a,100);this._tiles2=this._createTiles0(a,0);this._currentTiles=this._tiles;this._lastTiles=this._tiles2};J.prototype._createThumbs=function(a){this._thumbs=this._createThumbs0(a,100);this._thumbs2=this._createThumbs0(a,0);this._currentThumbs=this._thumbs;this._lastThumbs=this._thumbs2};J.prototype._createThumbs0=function(a,b){for(var c=Array(2),d=0;2>d;d++){var e=new Y;e.setAlpha(b);e.appendTo(a);c[d]=e}return c};J.prototype._createTiles0=function(a,b){for(var c=Array(ya),d=0;d<ya;d++)for(var e=0;e<jb;e++){var f=new V(d,e),g=this._getTileIndex(d,e);f.setAlpha(b);f.appendTo(a);c[g]=f}return c};J.prototype._getTileIndex=function(a,b){return a+b*ya};J.prototype._getTileURL=function(a,b,c){return this._getTileSite(b,c)+"?svid="+a+"&x="+b+"&y="+c+"&level=0&mtype=mobile"};J.prototype._getTileSite=function(a,b){return ba.tileDomain.replace("${x}",(a%3+b%3*3)%9)};J.prototype._getThumbURL=function(a){return ba.thumbDomain+"?svid="+a};var kb=function(){},Vb=Object.prototype.toString,lb={linear:function(a){return a},easeIn:function(a){return Math.pow(a,2)},easeOut:function(a){return Math.pow(a,.5)}},Pa=function(a,b){1==arguments.length&&"[object Function]"===Vb.call(a)&&(b=a,a=void 0);a=a||{};this.playFunc=b;this.playID=null;this.FPS=this.progress=0;this._fpss={n:0,startTime:0};this.status=1;this.options={begin:void 0!==a.begin?a.begin:0,end:void 0!==a.end?a.end:100,duration:a.duration||1e3,times:a.times||1,timingFunction:a.timingFunction||lb.linear,onBegin:a.onBegin||kb,onEnd:a.onEnd||kb,FPS:a.FPS||void 0}};Pa.extend=function(a,b){this.TIMING_FUNCTION[a]=b};Pa.TIMING_FUNCTION=lb;var fa=Pa.prototype;fa.play=function(){this.playID&&3!==this.status&&this.stop();var a=this,b=this.options,c=this.progress,d=b.end-b.begin;b.onBegin(b.begin);var e=a.options.duration;this.status=2;this.playID=Oa.add(null,function(f,g){var h=c+f/e;if(1>h)a.progress=h,h=b.begin+d*b.timingFunction(h),a.playFunc(h);else if(Infinity===b.times||0<--b.times)a.progress=0,a.play();else return a.stop(),!0},b.FPS)};fa.addTimes=function(a){this.options.times+=a};fa.stop=function(){this.progress=0;Oa.remove(this.playID);this.playFunc(this.options.end);this.options.onEnd();this.playID=null;this.FPS=0;this.status=4};fa.pause=function(){this.status=3;Oa.remove(this.playID)};fa.getProgress=function(){return this.progress};fa.getLeftTimes=function(){return this.options.times};var Ga=F,Q=Fa.prototype=new Ga;Q.constructor=Fa;Q.clone=function(){var a=new this.constructor([]);a.vertices=this.vertices;a.indices=this.indices;return a};Q.build=function(a){this.vertices=a;this.indices[0]=0;this.indices[1]=1;this.indices[2]=2;this.indices[3]=0;this.indices[4]=2;this.indices[5]=3};Q.clip=function(a){var b=a.camera.projectMatrix,c=[],d,e;m.each(this.vertices,function(f,g){d=a.coreMatrix.transformVector(f);e=b.transformVector(d);e.project();c.push(e)});return 0==a.clip(c,this.indices).length?[]:c};Q.getScreenPosition=function(a,b){var c=[];m.each(b,function(b,e){var f;f=a.viewPortMatrix.transformVector(b);c.push({x:f.x,y:f.y})});return c};Q.canvasRender=function(a,b){var c=a.canvas.getContext("2d");c.beginPath();c.strokeStyle="#000000";c.lineWidth="1";c.fillStyle="rgba(0,0,0,0)";c.moveTo(b[0],b[1]);m.each(b,function(a,b){c.lineTo(a.x,a.y)});c.closePath();c.stroke();c.fill()};Q.tileRender=function(a,b){};Q.stopRender=function(){this._isStopRender=!0};Q.restoreRender=function(){this._isStopRender=!1};Q.render=function(a){if(!0!==this._isStopRender){var b=this.clip(a);0!=b.length&&(b=this.getScreenPosition(a,b),this.tileRender(a,b))}};Q.reset=function(a){a&&a.removeObject3D(this)};var mb=function(){this._plugins=[]},la=mb.prototype;la.dispatchEvent=function(a,b,c){H.prototype.dispatchEvent.apply(this,arguments);for(var d=0,e=this._plugins.length;d<e;d++)this._plugins[d].getPano().dispatchEvent(a,b,c)};la._createPanoProxy=function(){return new La(this)};la.addPlugin=function(a){if(!(a instanceof da))throw Error("plugin not instanceof PanoPlugin");if(a.getPano())throw Error("plugin already added!");var b=this._createPanoProxy();a._pano=b;a._container&&this._panoContainer.appendChild(a._container);this._plugins.push(a);a.addToPano()};la.removePlugin=function(a){-1!==this._plugins.indexOf(a)&&(a.getPano().destroy(),a._pano=null,this._panoContainer.removeChild(a._container),a.removeFromPano())};var la=null,nb=0,ob="ongesturestart"in window,pb=function(a){this.elem=a;this.supportEvents={};this.handlers={};this.touches=[];this.startDelta=void 0};pb.prototype={on:function(a,b){var c="eid"+(new Date).getTime().toString(32)+ ++nb;if(!this.hasEvent(a)){var d=this,e=function(b){"touchstart"==a&&d.addTouch(b.changedTouches);b.extendData=d.getTouchData(b.changedTouches);"touchend"==a&&d.delTouch(b.changedTouches);return d.fire(a,[b])};this.elem.addEventListener(a,e,!1);this.supportEvents[a]=e;this.handlers[a]={}}this.handlers[a][c]={handler:b};return c},off:function(a,b){if(this.hasEvent(a)){var c,d=this.handlers[a];for(c in d)if(c==b){delete d[c];break}this.hasEvent(a)||(this.elem.removeEventListener(a,this.supportEvents[a],!1),delete this.supportEvents[a],delete this.handlers[a]);if(!this.hasEvent())return this.destory(),null}},fire:function(a,b){if(this.hasEvent(a)){var c,d=this.handlers[a],e=[];for(c in d)!0===d[c].handler.apply(this.elem,b)&&e.push(c);for(;e.length;)this.off(a,e.pop())}},hasEvent:function(a){var b;if(0==arguments.length){for(b in this.handlers)if(b)return!0;return!1}if(!this.handlers[a])return!1;for(b in this.handlers[a])if(b)return!0;return!1},destory:function(){for(var a in this.supportEvents)this.elem.removeEventListener(a,this.supportEvents[a],!1);this.handlers=this.supportEvents=this.elem=null},addTouch:function(a){for(var b,c=0,d=a.length;c<d;c++)b=a[c],this.touches.push({id:b.identifier,pageX:b.pageX,pageY:b.pageY});2==this.touches.length&&(this.startDelta=ra(this.touches[0],this.touches[1]))},delTouch:function(a){this.touches=[]},getTouchData:function(a){var b,c,d;(b=1<this.touches.length?!0:!1)?c=ra(this.touches[0],this.touches[1]):this.touches[0]&&(d={x:a[0].pageX-this.touches[0].pageX,y:a[0].pageY-this.touches[0].pageY});return{isGesturing:b,startDelta:this.startDelta,delta:c,offset:d}}};var U={},X={isSupportEvent:function(a,b){b=b||document.createElement("div");a="on"+a;var c=a in b;b.setAttribute&&!c&&(b.setAttribute(a,"return;"),c="function"===typeof b[a]);return c},isSupportedGesturechange:ob,on:function(a,b,c){var d=a.getAttribute("lKey"),e=U[d];if(!e){var e=new pb(a),f=d="eid"+(new Date).getTime().toString(32)+ ++nb;U[f]=e;a.setAttribute("lKey",f)}return{lKey:d,eName:b,eKey:e.on(b,c)}},off:function(a){for(a="[object Array]"===Object.prototype.toString.call(a)?a:[a];a.length;){var b=a.pop(),c=U[b.lKey];c&&null===c.off(b.eName,b.eKey)&&delete U[b.lKey]}},fire:function(a,b,c){(a=a.getAttribute("lKey"))&&U[a]&&(c=c?c.unshift(void 0):[void 0],U[a].fire(b,c))},clearAll:function(){for(var a in U)U[a].destory(),U[a]=null;U=null},drag:function(a,b,c,d){var e=this,f,g,h,n,q,s=!0;return this.on(a,"touchstart",function(t){f||(f=e.on(a,"touchmove",function(d){d.extendData.isGesturing||(n=d.changedTouches[0].pageX,q=d.changedTouches[0].pageY,s?(b&&b.apply(a,[d]),g={pageX:n,pageY:q,timeStamp:d.timeStamp},s=!1):2<ra(g,d.changedTouches[0])&&(h={x:n-g.pageX,y:q-g.pageY,t:d.timeStamp-g.timeStamp},g={pageX:n,pageY:q,timeStamp:d.timeStamp},c.apply(a,[d,h])))}),e.on(a,"touchend",function(b){d&&d.apply(a,[b,b.extendData.offsetByPrev]);e.off(f);f=null;return s=!0}))})},dbclick:function(a,b){var c,d;return this.on(a,"touchstart",function(a){a.extendData.isGesturing||(d={pageX:a.touches[0].pageX,pageY:a.touches[0].pageY,time:(new Date).getTime()},c&&250>d.time-c.time&&20>ra(d,c)?b&&b(a):c=d)})},clickHandlers:[],click:function(a,b){var c,d=null,e=-1<b.toString().indexOf(".stopPropagation()"),f=this.on(a,"touchstart",function(a){d?(clearTimeout(d),d=null,c=0,X.clickHandlers=[]):a.extendData.isGesturing||(c=new Date,e&&a.stopPropagation())}),g=this.on(a,"touchend",function(f){if(!f.extendData.isGesturing&&f&&f.extendData&&f.extendData.offset){var g=f.extendData.offset.x,q=f.extendData.offset.y;400>g*g+q*q&&300>new Date-c&&(e&&f.stopPropagation(),X.clickHandlers.push({handler:b,elem:a}),d||(d=setTimeout(function(){for(;X.clickHandlers[0];){var a=X.clickHandlers.shift();a.handler.apply(a.elem,[f])}d=null},249)))}});return[f,g]},stopNextClick:function(){X.clickHandlers=[]},gesture:function(a,b,c,d){if(ob){var e=[];b&&e.push(this.on(a,"gesturestart",b));c&&e.push(this.on(a,"gesturechange",c));d&&e.push(this.on(a,"gestureend",d));return e}}};window.onbeforeunload=function(){try{X.clearAll(),X=null}catch(a){}};var Wb=X;N.prototype.CLICK_DURATION=130;N.prototype.CLICK_INTERVAL=170;N.prototype.CLICK_OFFSET=30;N.prototype.handleEvent=function(a){a.stopPropagation();a.preventDefault();var b=a.targetTouches;switch(a.type){case"touchstart":if(1==b.length){b=b[0];if(!this._startTouch){this._startTouch={pageX:b.pageX,pageY:b.pageY,timeStamp:a.timeStamp};break}console.assert(!this._touch2,"\u6e05\u9664\u7b2c\u4e8c\u6b21touchstart\u5f02\u5e38");if(a.timeStamp-this._startTouch.timeStamp>this.CLICK_DURATION+this.CLICK_INTERVAL){console.log("Second touch start tool long, stop dbclick.");break}var c=this._startTouch;if(Math.abs(b.pageX-c.pageX)>this.CLICK_OFFSET&&Math.abs(b.pageY-c.pageY)>this.CLICK_OFFSET){console.log("Second touch start too far, stop dbclick.");break}this._touch2={pageX:b.pageX,pageY:b.pageY,timeStamp:a.timeStamp}}else this._clickTimer&&(clearTimeout(this._clickTimer),this._clickTimer=null),this._touch2=this._startTouch=null,this._lastDragEvt&&this._dispatchDragEnd(a);break;case"touchmove":this._lastDragEvt?this._dispatchDrag(a):this._startTouch&&this._dispatchDragStart(a);this._clickTimer&&(clearTimeout(this._clickTimer),this._touch2=this._clickTimer=null);this._startTouch=null;break;case"touchend":case"touchcancel":b=this._startTouch;c=this._touch2;if(b)if(console.assert(!this._lastDragEvt,"startTouch not cleared when move."),c)a.timeStamp-c.timeStamp<=this.CLICK_DURATION&&!this._lastDragEvt&&(clearTimeout(this._clickTimer),this._clickTimer=null,this._dispatchDbClick(a));else{if(this._clickTimer){console.log("Click timer is set, cancel it.");clearTimeout(this._clickTimer);this._startTouch=this._clickTimer=null;break}a.timeStamp-b.timeStamp<=this.CLICK_DURATION?this._clickTimer=setTimeout(this._dispatchClick,this.CLICK_DURATION+this.CLICK_INTERVAL,a,this):(this._startTouch=null,console.log("Click canceled, hold too long:"+(a.timeStamp-b.timeStamp)+", which is greater than "+this.CLICK_DURATION))}else console.assert(!c,"No start touch but second touch for click");this._lastDragEvt&&this._dispatchDragEnd(a);break;default:console.warn("Unexpected event for PanoEventDetector",a)}};N.prototype._dispatchClick=function(a,b){b=b||this;var c=b._startTouch;console.assert(c,"Dispatching click but no startTouch.");clearTimeout(b._clickTimer);b._clickTimer=null;b._startTouch=null;b._touch2=null;b._listener.onClick({type:"click",pageX:c.pageX,pageY:c.pageY,timeStamp:a.timeStamp})};N.prototype._dispatchDbClick=function(a){var b=this._startTouch,c=this._touch2;a={type:"dbclick",pageX:(b.pageX+c.pageX)/2,pageY:(b.pageY+c.pageY)/2,timeStamp:a.timeStamp};this._touch2=this._startTouch=null;this._listener.onDbClick(a)};N.prototype._dispatchDragStart=function(a){var b=a.changedTouches[0],c=this._startTouch;this._lastDragEvt=a={type:"dragstart",offsetX:b.pageX-c.pageX,offsetY:b.pageY-c.pageY,pageX:b.pageX,pageY:b.pageY,timeStamp:a.timeStamp};this._listener.onDragStart(a)};N.prototype._dispatchDrag=function(a){var b=a.changedTouches[0],c=this._lastDragEvt;this._lastDragEvt=a={type:"drag",offsetX:b.pageX-c.pageX,offsetY:b.pageY-c.pageY,dt:a.timeStamp-c.timeStamp,pageX:b.pageX,pageY:b.pageY,timeStamp:a.timeStamp};this._listener.onDrag(a)};N.prototype._dispatchDragEnd=function(a){a=this._lastDragEvt;this._lastDragEvt=null;a.type="dragend";a.offsetX=0;a.offsetY=0;this._listener.onDragEnd(a)};N.prototype.enable=function(){this._panoDom.addEventListener("touchstart",this,!0);this._panoDom.addEventListener("touchmove",this,!0);this._panoDom.addEventListener("touchend",this,!0);this._panoDom.addEventListener("touchcancel",this,!0)};N.prototype.disable=function(){this._panoDom.removeEventListener("touchstart",this,!0);this._panoDom.removeEventListener("touchmove",this,!0);this._panoDom.removeEventListener("touchend",this,!0);this._panoDom.removeEventListener("touchcancel",this,!0)};var xb=R,Bb=qa,Ha=l,yb=Ka,Ab=pa;S.prototype.extendSupportEvent=function(a){this._eventAction.canvas.addEventListener(a,function(a){},!1)};S.prototype.syncLookup=function(){var a=this._scene3d.camera,b=new x;b.appendRotate(this._panorama.getPitch()*Math.PI/180,[1,0,0]);b.appendRotate(this._panorama.getHeading()*Math.PI/180,[0,1,0]);a.lookAtTarget(b.transformVector(this._initTarget));var b=this._panorama,c=new x,d=this._panorama.getCore();c.appendRotate(b.getPitch()*Math.PI/180,[1,0,0]);c.appendRotate(b._getCoreHeading()*Math.PI/180,[0,1,0]);this._scene3d.coreMatrix=c;b=d.getFov()*Math.PI/180;a.fovy!=b&&(a.fovy=b,a.updateProjectMatrix())};S.prototype.render=function(){var a=this._panorama,b=this._scene3d.appParams;b.heading=a.getHeading();b.pitch=a.getPitch();b.pano=a;this.syncLookup();this._scene3d.render()};S.prototype.getProjectionPosition=function(a,b){this.syncLookup();var c=this._panorama;c.getCore();var d=c.getFov(),e=this._scene3d.camera,c=c.getViewHeight(),d=.5/Math.tan(d*Math.PI/360)*c,d=m.getWorldPosition(a,b,2*d),d=this._scene3d.coreMatrix.transformVector(d),e=e.projectMatrix.transformVector(d);e.project();if(0!=this._scene3d.clip([e],[0,0,0]).length)return e=this._scene3d.viewPortMatrix.transformVector(e),{z:d.z,x:e.x,y:e.y}};S.prototype.setViewport=function(a,b){this._scene3d.viewPort(0,0,a,b);this._canvas.width=a;this._canvas.height=b;this.syncLookup();this.render()};S.prototype.setZoom=function(){};S.prototype.addObject3D=function(a){if(Array.isArray(a))for(var b=0;b<a.length;b++)this._scene3d.addObject3D(a[b]);else this._scene3d.addObject3D(a)};S.prototype.getScene=function(){return this._scene3d};S.prototype.getCamera=function(){return this._scene3d.camera};var qb=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(a){return setTimeout(a,1e3/35)},Cb=z,$a=H,Db=J;ua(p,$a);p.prototype.isPreLoad=function(){return this._isPreLoad};p.prototype.setSvid=function(a){this._svid=a;this._render()};p.prototype._loadThumb=function(a){console.warn("Custom tile not implemented in dompano")};p.prototype.setViewPort=function(a,b){this._viewWidth=a;this._viewHeight=b;this._resetZoomFactor(this._zoom);this._render()};p.prototype.setHeading=function(a){this._heading=a;this._render()};p.prototype.setPitch=function(a){this._setPitchImpl(a);this._render()};p.prototype._setPitchImpl=function(a){var b=this._getMinPitch(),c=this._getMaxPitch();this._pitch=a;this._pitch=Math.max(b,this._pitch);this._pitch=Math.min(c,this._pitch)};p.prototype.setZoom=function(a){this._zoom=a;this._tileZoom=this._zoom*this._ZoomFactor;this._render()};p.prototype.getSvid=function(){return this._svid};p.prototype.getHeading=function(){return this._heading};p.prototype.getPitch=function(){return this._pitch};p.prototype.getZoom=function(){return this._zoom};p.prototype.getFov=function(){return this._fovy};p.prototype.getTileZoom=function(){return this._tileZoom};p.prototype.getCenter=function(){return this._getPositionImpl(this._heading,this._pitch,this._tileZoom)};p.prototype.getBounds=function(){var a=this.getCenter(),b=this._getTilesViewWidth(),c=this._getTilesViewHeight();return new K(a.x-b/2,a.y-c/2,b,c)};p.prototype.getCompositeBounds=function(){var a=this.getCenter(),b=this._getTilesViewWidth(),c=this._getTilesViewHeight(),d=a.x-b/2,a=a.y-c/2;if(0>d){var d=b+d,e=b-d,f=this._config.TILES_WIDTH-e,b=new K(0,a,d,c),c=new K(f,a,e,c),e=new W;e.addSubRectangle(c);e.addSubRectangle(b)}else d+b>this._config.TILES_WIDTH?(e=this._config.TILES_WIDTH-d,b=new K(0,a,b-e,c),c=new K(d,a,e,c),e=new W,e.addSubRectangle(c),e.addSubRectangle(b)):(e=new W,c=new K(d,a,b,c),e.addSubRectangle(c));return e};p.prototype.setMinPitch=function(){};p.prototype.setMaxPitch=function(){};p.prototype.getProjectionPosition=function(a,b){for(var c=this._getPositionImpl(a,-b,this._tileZoom),d=this.getCompositeBounds(),e=d.getSubCount(),f,g=0;g<e;g++){var h=d.getSubRectangle(g);if(h.contains(c)){f=h;break}}if(null!=f)return 2==e?(d=d.getSubRectangle(0),d=f==d?f.x:-d.width):d=f.x,new aa((c.x-d)*this._tileZoom,(c.y-f.y)*this._tileZoom)};p.prototype._getTilesViewWidth=function(){return this._viewWidth/this._tileZoom};p.prototype._getTilesViewHeight=function(){return this._viewHeight/this._tileZoom};p.prototype._getPositionImpl=function(a,b,c,d){d=d||this._config.BEGIN_HEADING;a=this._getValidRatio((a-d)/360);return new aa(this._config.TILES_WIDTH*a,b/180*this._config.TILES_HEIGHT+this._config.TILES_HEIGHT/2)};p.prototype._getValidRatio=function(a){return 0>a?Math.ceil(-a)+a:1<a?a-Math.floor(a):a};p.prototype._render=function(){null==this._animationId&&(this._animationId=qb(m.bindThis(this._doRender,this)))};p.prototype._doRender=function(){this._animationId=null;this._tileManager.refresh();this.dispatchEvent("refresh")};p.prototype._getMaxPitch=function(){var a=this._getViewPitchRange()/2;return this._bottomPitch-a};p.prototype._getMinPitch=function(){var a=this._getViewPitchRange()/2;return this._topPitch+a};p.prototype._getViewPitchRange=function(){return 180*(this._getTilesViewHeight()/this._config.TILES_HEIGHT)};p.prototype._resetZoomFactor=function(a){this._ZoomFactor=180*this._viewHeight/(this._fovy*this._config.TILES_HEIGHT);this._tileZoom=a*this._ZoomFactor;var b=this._tileZoom*this._config.TILE_WIDTH,b=Math.round(b);this._tileZoom=b/this._config.TILE_WIDTH;this._ZoomFactor=this._tileZoom/a};var bb=H,I=m,Fb=function(){return{isFirstLoadingTile:!0,_allowLoadTiles:!1,_tileImages:{},_tile3DOverlays:{},_tileData:{},_loadingCount:0,_loadedCount:0,setAllowLoadTiles:function(a){this._allowLoadTiles=a},add:function(a,b){this._tileData[a]={overlay3D:b};b.manager=this},resetAllImgLoadState:function(){for(var a in this._tileData)this._tileData[a].overlay3D.restoreRender()},getAllTile3D:function(){var a=[],b;for(b in this._tileData)a.push(this._tileData[b].overlay3D);return a},renderTile:function(a){a=this._tileData[a];this._allowLoadTiles&&a&&(this.isFirstLoadingTile&&(setTimeout(function(a){a.isFirstLoadingTile=!1},0,this),this._loadingCount++),a.overlay3D.stopRender(),a=a.overlay3D.texture,a.src=a.dataset.src)},tileLoaded:function(a){if(this._tileData[a]&&null!==this._loadingCount)return this._loadedCount++,a=this._loadedCount/this._loadingCount,1<=a?(this._loadedCount=this._loadingCount=null,1):a}}};ua(D,bb);D.prototype.get3DOverlays=function(){return this._tileMgr.getAllTile3D()};D.prototype.getPerspective=function(){return.5/Math.tan(this._fovy*Math.PI/360)*this._viewHeight};D.prototype._prepareTileSrc=function(){for(var a=this.get3DOverlays(),b=a.length-1;0<=b;b--){var c=a[b].texture.dataset,d=c,e;e=this._svid;var f=c.x,c=c.y,g=this._level;if(e){var h=0==g?"cube":"mobile-cube";e=[ba.tileDomain.replace("${x}",(f+2*c)%8),"?svid="+e,"&x="+f,"&y="+(c||0),"&level="+("cube"==h?0:g-1),"&mtype="+h,"&from=web"].join("")}else e="";d.src=e}};D.prototype.setSvid=function(a){this._svid=a;this._loadThumb();this._prepareTileSrc()};D.prototype._buildTilesContainer=function(){var a=this.getPerspective();this._tileContainer=I.createElem("div",{position:"absolute",left:"0px",top:"0px",width:"100%",height:"100%",overflow:"hidden","-webkit-perspective":a});this._containerDom.appendChild(this._tileContainer);this._tileLayer=I.createElem("div",{position:"absolute",width:"100%",height:"100%","-webkit-transform-style":"preserve-3d","-webkit-transform":"translateZ("+a+"px) rotateX(0deg) rotateY(0deg)","z-index":3});this._tileContainer.appendChild(this._tileLayer);for(var a=[],b=this._tileCount*this._tileWidth,c=0;6>c;c++){var d=I.createElem("div",{"-webkit-backface-visibility":"hidden",position:"absolute",width:b+"px",height:b+"px","-webkit-transform":cb(this,c),overflow:"hidden"});a.push(d);var e=I.createElem("img",{position:"absolute",width:6*b+"px",height:b+"px",left:-c*b+"px"});this._thumbImgs.push(e);e.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAQAIBRAA7";for(var f=I.createElem("div",{position:"absolute",width:b+"px",height:b+"px"}),g=f,h=c,n=h*this._tileCount,q=this.getPerspective(),s=2*q,s=new Fa([I.getWorldPosition(-45,35,s),I.getWorldPosition(0,45,s),I.getWorldPosition(0,0,s),I.getWorldPosition(-45,0,s)]),t=0;t<this._tileCount;t++)for(var l=0;l<this._tileCount;l++){var k=n+l,m=I.createElem("img",{width:this._tileWidth+"px",height:this._tileWidth+"px","float":"left",top:t*this._tileWidth+"px",left:l*this._tileWidth+"px","z-index":2});m.ondragstart=ab;m.onselectstart=ab;m.onload=this._onTileImgLoaded;var p="i_"+k+"_"+t;m.dataset.x=k;m.dataset.y=t;m.style.transition="opacity 300ms ease-out";m.style.opacity=0;g.appendChild(m);var r=s.clone();r.texture=m;r.translateSelf(k%this._tileCount*q,-q*t,0);4>h?r.rotateSelf(-Math.PI/2*h,[0,1,0]):4==h?r.rotateSelf(Math.PI/2,[1,0,0]):r.rotateSelf(Math.PI/2,[-1,0,0]);r.imgID=p;r.tileRender=Gb;this._tileMgr.add(p,r)}d.appendChild(e);d.appendChild(f);this._tileLayer.appendChild(d)}this._thumbImgs[0].onload=this._onThumbLoaded;this._cubeSideDivs=a};D.prototype.setPov=function(a,b){this._heading=a;this._pitch=b;this.render()};D.prototype.setHeading=function(a){this._heading=a;this.render()};D.prototype.setPitch=function(a){this._pitch=a;this.render()};D.prototype.getFovy=function(){return this._fovy};D.prototype.getFov=function(){return this._fovy};D.prototype.setFovy=function(a){this._fovy=a};D.prototype.setZoom=function(a){this.setFovy(this._baseFovy-20*(a-1));this.render();a=this.getPerspective();this._tileLayer.style.webkitTransform=this._tileLayer.style.webkitTransform.replace(/translateZ\(([^\)]+)\)/,"translateZ("+a+"px)");B.android&&B.chrome||(this._tileContainer.style.webkitPerspective=a)};D.prototype.setViewPort=function(a,b){this._viewWidth=a;this._viewHeight=b;var c=this.getPerspective();this._tileContainer.style.webkitPerspective=c;this._tileLayer.style.webkitTransform=this._tileLayer.style.webkitTransform.replace(/translateZ\(([^\)]+)\)/,"translateZ("+c+"px)");I.setStyles(this._tileContainer,{width:a+"px",height:b+"px"});I.setStyles(this._tileLayer,{width:a+"px",height:b+"px"});for(c=this._cubeSideDivs.length-1;0<=c;c--)this._cubeSideDivs[c].style.webkitTransform=cb(this,c);this.render()};D.prototype.render=function(){null===this._renderId&&(this._renderId=qb(this._doRender))};D.prototype._doRender=function(){this._tileLayer.style.webkitTransform=this._tileLayer.style.webkitTransform.replace(/rotateX\(([^\)]+)\)/,"rotateX("+ -this._pitch+"deg)").replace(/rotateY\(([^\)]+)\)/,"rotateY("+this._heading+"deg)");this._renderId=null;this.dispatchEvent("refresh")};D.prototype._loadThumb=function(a){a&&this.setSvid(null);a=a||ba.thumbDomain+"?svid="+this._svid+"&x=0&y=0&from=html5&level=0&mtype=mobile-cube";for(var b=this._thumbImgs.length-1;0<=b;b--)this._thumbImgs[b].src=a};D.prototype._onThumbLoaded=function(){this._hideTiles();this.dispatchEvent("thumbLoaded");this._loadTiles()};D.prototype._hideTiles=function(){for(var a=this._cubeSideDivs.length-1;0<=a;a--)for(var b=this._cubeSideDivs[a].children[1].children,c=b.length-1;0<=c;c--)b[c].style.transition="",b[c].style.opacity=0};D.prototype._loadTiles=function(){this._tileMgr.setAllowLoadTiles(!1);this._tileMgr.resetAllImgLoadState();this._tileMgr.setAllowLoadTiles(!0);this.render()};var Ib=D,Jb=p,db=H,Ia=B,Kb=S,Hb=x,P=m,sa=ba,Mb={create:function(){function a(){g=null;e.dispatchEvent("movestart")}function b(a){a=a.data;a={x:a.offsetX,y:a.offsetY,t:a.dt};var b=e.getHeading()-.25*a.x,c=e.getPitch()-.25*a.y;e.setPov({pitch:c,heading:b});g=a}function c(a,b){if(g){var c=g.x/g.t*h*.25,k=g.y/g.t*h*.25,m=Math.sqrt(c*c+k*k),r=1;m>q*n&&(r=q*n/m,m*=r,c*=r,k*=r);var u=m/q,p=c*c/(2*q);0>c&&(p=-p);var v=k*k/(2*q);0>k&&(v=-v);var y=Date.now(),x=e.getHeading(),z=e.getPitch(),A=l.Circ.easeOut;d();f=setInterval(function(){var a=Date.now()-y;if(a>u)d();else{var b=A(a,x,-p,u),a=A(a,z,-v,u);e.setPov({heading:b,pitch:a})}},100/60);g=null}}function d(){f&&(clearInterval(f),f=null,e.dispatchEvent("moveend"))}var e,f,g,h=1,n=1200,q=180/(n*n),l={Circ:{easeIn:function(a,b,c,d){return-c*(Math.sqrt(1-(a/=d)*a)-1)+b},easeOut:function(a,b,c,d){return c*Math.sqrt(1-(a=a/d-1)*a)+b},easeInOut:function(a,b,c,d){return 1>(a/=d/2)?-c/2*(Math.sqrt(1-a*a)-1)+b:c/2*(Math.sqrt(1-(a-=2)*a)+1)+b}}};return{addToPano:function(f){e=f;f.on("touchstart",d);f.on("dragstart",a);f.on("drag",b);f.on("dragend",c)},removeFromPano:function(a){}}}},Nb={create:function(){function a(a){var b=h.getModel().detail.vpoints.filter(function(b,c,d){return b.svid==a});return 1==b.length?b[0].link:[]}function b(a,b){var c=b.filter(function(b,c,d){return 0!=b.points.filter(function(b,c,d){return b.svid==a}).length});return 1==c.length?c[0]:null}function c(c){if(!c||0==c.length)return[];var d=h.getSvid(),e=[];b(d,c).points.forEach(function(b,c,f){b.svid==d&&(f[c-1]?e.push(f[c-1]):e=e.concat(a(d)),1!=f.length&&(f[c+1]?e.push(f[c+1]):e=e.concat(a(d))))});return e}function d(a){return a.filter(function(a,b,c){return 1==a.connected})}function e(){n.reset();h.scene.render()}function f(a){var b=Math.PI;a+=b/8;a>=2*b&&(a-=2*b);a=parseInt(4*a/b);return"\u5317 \u4e1c\u5317 \u4e1c \u4e1c\u5357 \u5357 \u897f\u5357 \u897f \u897f\u5317".split(" ")[a]}function g(a){var b,c;a.forEach(function(a,d,g){function l(a){e();h.setSvid(y)}var k=n.getArrow(),m=h.getModel().detail.basic,q=a.x-m.x,m=a.y-m.y,m=Math.acos(m/Math.sqrt(q*q+m*m)),m=0>q?2*Math.PI-m:m;c||(c=m);k.labelDom.addEventListener("touchend",function(){e();h.setSvid(y)},!1);var q=f(m),p=Math.abs(m-b);p>Math.PI&&(p=Math.PI-p);p=Math.PI;c&&(p=Math.abs(m-c),p>Math.PI&&(p=Math.PI-p));d===g.length-1&&(k.setLabel(q),h.getControlLayer().appendChild(k.labelDom),b=m);k.rotateSelf(-m,[0,1,0]);h.scene.addObject3D(k);var y=a.svid,x=!1;k.addListener("touchstart",function(a){a.data.evt.stopPropagation();a.data.evt.preventDefault();x=!0;k.renderOptions={fillStyle:"#ccffff"};h.scene.render()});k.addListener("touchmove",function(a){x=!1;k.renderOptions={};h.scene.render()});k.addListener("touchend",function(a){x&&(x=null,l.apply(this,[a]),setTimeout(function(){Wb.stopNextClick()},0))})});h.scene.render()}var h,n={inUse:[],getArrow:function(){var a=new M;this.inUse.push(a);return a},reset:function(){for(;this.inUse[0];){var a=this.inUse.pop();a.removeListener();a.reset()}}};return{addToPano:function(a){h=a;h.addListener("svid_changed",function(b){setTimeout(function(){a.scene.syncLookup();var b;b=h.getModel();var e=b.detail.roads;(b=e?c(e):(b=b.detail.points)?d(b):null)&&g(b)},500)});h.addListener("svid_changed",e)},removeFromPano:function(){}}}},Ob={create:function(){function a(a,b){var e=a.x-b.x,f=a.y-b.y;return Math.sqrt(e*e+f*f)}var b;return{addToPano:function(c){b=c;b.onadvance=function(c){a:{c=c.changedTouches[0];var e=b.getModel().detail.basic.type;if(-1!==["park","street"].indexOf(e)&&(c=b.screenPosToGeoPos(c.clientX,c.clientY))){for(var e=[],f=b.getModel().detail,g=f.roads||[],h=0;h<g.length;h++)e=e.concat(g[h].points);var e=e.concat(f.vpoints),e=e.concat(f.points||[]),f=Number.MAX_VALUE,k=null,g=null,h=b.getModel().detail.basic,k=a(c,h);if(5>k)c=void 0;else{for(k=e.length-1;0<=k;k--){var l=e[k];if(l.svid!==b.getSvid()){var s=a(c,l);a(h,l);var p=m.getPOV(h.x,h.y,l.x,l.y),p=Math.abs(b.getHeading()-p.heading)%180;s<f&&90>p&&(f=s,g=l)}}c=g}if(c){b.setSvid(c.svid);b.scene.setViewport(innerWidth,innerHeight);c=c.svid;break a}}c=void 0}return c}}}}},eb=mb,ja=!1;ua(k,db);(function(a,b){for(var c in b.prototype)"constructor"!==c&&(a.prototype[c]=b.prototype[c])})(k,eb);k.prototype.DEFAULT_MIN_PITCH=-90;k.prototype.DEFAULT_MAX_PITCH=5;k.prototype.MIN_ZOOM=1;k.prototype.MAX_ZOOM=4;k.prototype._initPanoListeners=function(){var a=this;this._panoCore.addListener("tileLoading",function(b){a.dispatchEvent("tile_loading",b.data)});var b=(new Date).getTime(),c=null;this._panoCore.addListener("tileLoaded",function(d){c||(c=a.addListener("click",function(){a.stopOverlayChanged||(a.isOverlayVisible=!a.isOverlayVisible,a.dispatchEvent("overlay_visible_changed",{isOverlayVisible:a.isOverlayVisible}))}));a.dispatchEvent("tile_loaded");P.report2((new Date).getTime()-b)});this._panoCore.addListener("refresh",function(b){a.dispatchEvent("render");a.scene.render()});this._panoCore.addListener("thumbLoaded",function(b){a.dispatchEvent("thumb_loaded")});this._eventDetector=new N(this._sceneMask,this);this._sceneMask.addEventListener("touchstart",function(b){a.dispatchEvent("touchstart",b)},!1)};k.prototype.onClick=function(a){};k.prototype.onDbClick=function(a){};k.prototype.onDragStart=function(a){this.dispatchEvent(a.type,a)};k.prototype.onDrag=function(a){this.dispatchEvent(a.type,a)};k.prototype.onDragEnd=function(a){this.dispatchEvent(a.type,a)};k.prototype._buildContainer=function(){window.getComputedStyle(this._containerDom).position.match(/relative|absolute|fixed/)||(this._containerDom.style.position="relative");this._panoContainer=P.createElem("div",{position:"absolute",left:"0px",top:"0px",width:"100%",height:"100%",overflow:"hidden"});ja&&(this._panoContainer.className="pano-container");this._containerDom.appendChild(this._panoContainer);this._sceneContainer=P.createElem("div",{position:"absolute","z-index":-1,"pointer-events":"none",left:"0px",top:"0px",width:"100%",height:"100%"});ja&&(this._sceneContainer.className="scene-container");this._panoContainer.appendChild(this._sceneContainer);this._canvas=P.createElem("canvas",{position:"absolute"});this._panoContainer.appendChild(this._canvas);if(this._options.hasLogo){var a=P.createElem("img",{position:"absolute",right:"2px",bottom:"0px"});a.src=sa.logo;a.width=73;a.height=20;this._panoContainer.appendChild(a)}this._sceneMask=P.createElem("div",{position:"absolute",left:"0px",top:"0px",width:"100%",height:"100%"});ja&&(this._sceneMask.className="scene-mask event-layer");this._panoContainer.appendChild(this._sceneMask)};k.prototype.setThumb=function(a){this._panoCore._loadThumb(a)};k.prototype.addPlugin=function(a){a.addToPano(this)};k.prototype.getOverlayVisible=function(){return this.isOverlayVisible};k.prototype.setOverlayVisible=function(a){this.isOverlayVisible!==a&&(this.isOverlayVisible=a,this.dispatchEvent("overlay_visible_changed",{isOverlayVisible:this.isOverlayVisible}))};k.prototype.getModel=function(){return this._model};k.prototype.setSvid=function(a){if(!a||"string"!=typeof a)throw Error("Pano id must be string");a!=this._svid&&(this._svid=a,this._panoCore&&this._panoCore.setSvid(a),this.stopOverlayChanged=!0,this._loadPanoInfo())};k.prototype.getSvid=function(){return this._svid};k.prototype._loadPanoInfo=function(){var a=localStorage.getItem("suid");if(!a){var b=(new Date).getUTCMilliseconds(),a=Math.round(2147483647*Math.random())*b%1e10;localStorage.setItem("suid",a)}b=this._options;a=sa.svDataUrl+"/sv?pf="+b.pf+"&svid="+this._svid+"&suid="+a+"&from="+b.from+"&ch="+b.ch;b.key&&(a+="&key="+b.key);P.loadJsonp(a,this._onSvDataLoaded)};k.prototype._onSvDataLoaded=function(a){if(-1==a.info.error)console.error("Invalid panoranam id.",a),this.dispatchEvent("error",Error("Invalid panoranam id."));else{var b=a.detail.basic;this._svid!=b.svid?console.warn("Request svid and response svid not the same!"):(this._svid=b.svid,this._model=a,this.data.scenicId=b.scenic_id,this.data.geoPos.x=b.x,this.data.geoPos.y=b.y,this._minPitch=b.pitch_min||this.DEFAULT_MIN_PITCH,this._maxPitch=b.pitch_max||this.DEFAULT_MAX_PITCH,b=Number(b.dir),b!==this.data.cameraDir&&(this.data.cameraDir=b,ja&&console.warn("Camera dir changed."),null===this._heading?this._heading=b:this._panoCore.setHeading(this._getCoreHeading())),this.stopOverlayChanged=!1,this.dispatchEvent("svid_changed",a))}};k.prototype.faceToPlace=function(a,b,c,d){var e=this;e.stopOverlayChanged=!0;P.getXfPanoInfo(a,b,c,d,function(a){e.stopOverlayChanged=!1;if(-1==a.info.error)console.error("\u5438\u9644\u63a5\u53e3\u8fd4\u56de\u9519\u8bef",a),e.dispatch("error","\u5438\u9644\u63a5\u53e3\u8fd4\u56de\u9519\u8bef");else{var d=e.data.geoPos,d=P.getPOV(d.x,d.y,b,c);e.setHeading(d.heading);e.setSvid(a.detail.svid)}})};k.prototype.addMarker=function(a,b,c,d){if(!this.getModel())return!1;var e=P.getRandomID();a={elem:c,heading:a,pitch:b,isVisibile:void 0==d?this.isOverlayVisible:d};this._avoidMarkers(a);this.markers.content[e]=a;this.markers.length++;return e};k.prototype._avoidMarkers=function(a){var b=this.markers.content,c=parseInt(a.elem.style.width||a.elem.clientWidth)+2,d=parseInt(a.elem.style.height||a.elem.clientHeight)+2,e=.5/Math.tan(this._baseFovy*Math.PI/360)*this.getViewHeight(),f=360*Math.atan(.5*c/e)/Math.PI,g=360*Math.atan(.5*d/e)/Math.PI,h,k,l;for(l in b)h=b[l],c=parseInt(h.elem.style.width||h.elem.clientWidth)+2,d=parseInt(h.elem.style.height||h.elem.clientHeight)+2,c=360*Math.atan(.5*c/e)/Math.PI,d=360*Math.atan(.5*d/e)/Math.PI,c=new K(h.heading,h.pitch,c,d),k=new K(a.heading,a.pitch,f,g),180<h.heading-a.heading?k.x+=360:-180>h.heading-a.heading&&(c.x+=360),k.intersects(c)&&(a.pitch=h.pitch+d)};k.prototype.getHeadingRangeByCenter=function(a){var b=this.getFov(),b=.5/Math.tan(b*Math.PI/360)*this.getViewHeight();return 360*Math.atan(.5*a/b)/Math.PI};k.prototype.getAllMarkers=function(){return this.markers.content};k.prototype.getMarker=function(a){return this.markers.content[a]};k.prototype.removeMarker=function(a){if(a&&this.markers.content[a]){var b=this.markers.content[a].elem;b.ontouchend=b.ontouchstart=null;b.parentNode.removeChild(b);delete this.markers.content[a];this.markers.length--}else if(!a)for(b in this.markers.content)this.removeMarker(b)};k.prototype.showMarker=function(a){this._refreshMarkers(a,!0,!0)};k.prototype.hideMarker=function(a){this._refreshMarkers(a,!1,!1,!1)};k.prototype.setIsForceRefresh=function(a){this.isForceRefresh=a};k.prototype.refreshMarkersPosition=function(a){if(!this.isForceRefresh&&!this.isOverlayVisible)return!1;this._refreshMarkers(a,!0,!0)};k.prototype._refreshMarkers=function(a,b,c,d){var e=this.markers,f=this,g,h,k;if(0==e.length)return!0;var l=function(a){if(a){var e=f._panoCore;if(b){var h=f._getCoreHeading(a.heading),k=a.pitch;if(g=e.getProjectionPosition?e.getProjectionPosition(h,k):f.scene.getProjectionPosition(h,k))a.elem.style.left=g.x+"px",a.elem.style.top=g.y+"px"}c&&void 0===d&&(g&&!1===a.isVisibile?(a.elem.style.display="block",a.isVisibile=!0):void 0===g&&!0==a.isVisibile&&(a.elem.style.display="none",a.isVisibile=!1));void 0!==d&&(!0===d&&!1==a.isVisibile?(a.elem.style.display="",a.isVisibile=!0):!0==a.isVisibile&&(a.elem.style.display="none",a.isVisibile=!1))}};if(a)for(h=0,k=a.length;h<k;h++)l(e.content[a[h]]);else for(h in e.content)l(e.content[h]);this.dispatchEvent("marker_refresh");return this};k.prototype.setPov=function(a,b){this.setHeading(a.heading);this.setPitch(a.pitch)};k.prototype.getPOIPos=function(a,b){var c=this._getCoreHeading(a),d=-b;return this._panoCore.getProjectionPosition?this._panoCore.getProjectionPosition(c,d):this.scene.getProjectionPosition(c,d)};k.prototype._getCoreHeading=function(a){return(a||this._heading)-this.data.cameraDir};k.prototype.setHeading=function(a){if(null!=a){a=Number(a);if(isNaN(a))throw TypeError("Heading must be number.");a%=360;0>a&&(a+=360);a!==this._heading&&(this._heading=a,this._panoCore&&this._panoCore.setHeading(this._getCoreHeading()))}};k.prototype.getHeading=function(){return this._heading};k.prototype.setPitch=function(a){if(null!=a){a=Number(a);if(isNaN(a))throw TypeError("Pitch must be number.");a%=360;0>a&&(a+=360);270<a?a-=360:180<a&&(a=180-a);a=Math.min(a,this._maxPitch);a=Math.max(this._minPitch,a);a!==this._pitch&&(this._pitch=a,this._panoCore&&this._panoCore.setPitch(a))}};k.prototype.getPitch=function(){return this._pitch};k.prototype.setZoom=function(a){if(null!=a){a=Number(a);if(isNaN(a))throw TypeError("Zoom must be number.");a=Math.max(Math.min(a,this.MAX_ZOOM),this.MIN_ZOOM);a!==this._zoom&&(this._zoom=a,this._panoCore&&this._panoCore.setZoom(a))}};k.prototype.getZoom=function(){return this._zoom};k.prototype.getCore=function(){return this._panoCore};k.prototype.getFov=function(){return this._panoCore.getFov()};k.prototype.getControlLayer=function(){var a=document.createElement("div");a.style.position="absolute";a.style.width=0;a.style.height=0;this._panoContainer.appendChild(a);return a};k.prototype.getViewWidth=function(){return this._viewWidth};k.prototype.getViewHeight=function(){return this._viewHeight};var za=null;k.prototype.updateViewport=function(a,b){var c=this;a=a||this._containerDom.clientWidth;b=b||this._containerDom.clientHeight;if(a!=this._viewWidth||b!=this._viewHeight)this.stopOverlayChanged=!0,null!==za&&clearTimeout(za),za=setTimeout(function(){c.stopOverlayChanged=!1;za=null},200),this._viewWidth=a,this._viewHeight=b,this._panoCore.setViewPort(a,b),this.scene.setViewport(a,b),this.dispatchEvent("resize")};k.prototype.setViewPort=function(a,b){this.updateViewport(a,b)};k.prototype.addOverlay=function(a){this.scene.addObject3D(a)};k.prototype.screenPosToHeadingPitch=function(a,b){var c=this.scene.getScene().viewPortMatrix.clone();c.invert();var d=new l(a,b,1),d=c.transformVector(d),c=this.scene.getCamera().projectMatrix.clone();c.invert();d=c.transformVector(d);c=this.scene.getScene().coreMatrix.clone();c.invert();var c=d=c.transformVector(d),d=new aa(0,-1),e=new aa(c.x,c.z);e.normalize();d=180*Math.acos(d.dotProduct(e))/Math.PI;0>c.x&&(d=360-d);e=new l(c.x,0,c.z);e.normalize();var f=c.clone();f.normalize();e=180*Math.acos(f.dotProduct(e))/Math.PI;90<e&&(e=180-e);0>c.y&&(e=-e);return{heading:d,pitch:e}};k.prototype.screenPosToGeoPos=function(a,b){var c=this.screenPosToHeadingPitch(a,b);if(!(0<=c.pitch)){var d=c.heading+this.data.cameraDir,e=-2.3/Math.tan(c.pitch*Math.PI/180),f=e*Math.cos(d*Math.PI/180),e=e*Math.sin(d*Math.PI/180),g=this.getModel().detail.basic;return{x:g.x+e,y:g.y+f,h:0,heading:d,pitch:c.pitch}}};k.prototype.isMiniAlbum=function(){return this.data.scenicId?!0:!1};var Xb=m.lngFrom4326ToProjection,Yb=m.latFrom4326ToProjection,Zb=m.getPOV,rb=function(a,b){if("object"!==typeof b||null===b||!a)throw Error("parameter is not valid! by:Proxy");var c=b.container;"string"===typeof c&&(b.container=document.getElementById(c));if(!b.container||b.container.nodeType!==HTMLElement.prototype.ELEMENT_NODE)throw Error("options.container is not valid!");this.model=a;this.model._render=this;this.autoPlaytime=null;this._pendingLabels=[];this._pendingMarkers=[];this.labels={};this.markers={};this.labelsOpt={};this.markersOpt={};this._markerContainer=Pb();c=this._container=b.container;delete b.container;b.svid=b.pano;b.canMove=!b.disableMove;b.hasLogo=!b.disableLogo;this.pano=new k(c,b);var d=this;this.pano._panoContainer.appendChild(this._markerContainer);this.fireModelEvent("loaded");this.pano.addListener("svid_changed",Ja(this._onSvidChanged,this));this.pano.addListener("render",Ja(this._onRender,this));this.pano.addListener("error",Ja(this._onError,this));this.pano.addListener("thumbLoaded",$(this.fireModelEvent,this,"thumb_loaded"));this.pano.addListener("dragstart",$(this.fireModelEvent,this,"dragstart"));this.pano.addListener("dragend",$(this.fireModelEvent,this,"dragend"));this.pano.addListener("dragstart",function(){clearInterval(d.autoPlaytime)})},A=rb.prototype;A.fireModelEvent=function(a,b,c){this.model.fireEvent(a,b,c)};A.updateViewport=function(){this.pano.updateViewport()};A._onSvidChanged=function(a){a=a.data.detail;a=a.basic;var b=a.svid;a={svid:b,x:a.x,y:a.y,mode:a.mode,sno:a.sno,source:a.source,photoTime:"20"+b.substr(8,2)+"."+b.substr(10,2),dir:Number(a.dir)};this._updateLabelPov();this.fireModelEvent("pano_changed",a);var c=this._pendingLabels;this._pendingLabels=null;if(c)for(a=0,b=c.length;a<b;a++)this.addLabel(c[a]);c=this._pendingMarkers;this._pendingMarkers=null;if(c)for(a=0,b=c.length;a<b;a++)this.addLabel(c[a])};A._onRender=function(){var a=this.pano.getHeading(),b=this.pano.getPitch(),c=this.pano.getZoom();this.hpz&&this.hpz.h===a&&this.hpz.p===b||this.fireModelEvent("pov_changed",{heading:a,pitch:b});this.hpz&&this.hpz.zoom===c||this.fireModelEvent("zoom_changed",c);this.hpz={h:a,p:b,z:c}};A._onError=function(a){this.fireModelEvent("error",a.data)};A.removePano=function(){this.model=this.pano=null};A._getKey=function(a){return this["get"+a.slice(0,1).toUpperCase()+a.slice(1)]()};A.setPov=function(a){if(!a||isNaN(a.heading)||isNaN(a.pitch))throw Error("parameter is not valid! by:Proxy.setPov");var b=this.pano;b.setHeading(a.heading);b.setPitch(a.pitch)};A.getPov=function(){return{heading:this.pano.getHeading(),pitch:this.pano.getPitch()}};A.setPano=function(a){this.pano.setSvid(a)};A.getPano=function(){return this.pano.getSvid()};A.setZoom=function(a){this.pano.setZoom(a)};A.getZoom=function(){return this.pano.getZoom()};A.onLabelEvent=function(a){this.fireModelEvent("labelEvent",a)};A.addLabel=function(a){if(!a||"object"!==typeof a||isNaN(a.altitude)||"boolean"!==typeof a.visible)throw Error("parameter is not valid! by:addLabel()");if(!a.position||"object"!==typeof a.position||isNaN(a.position.lat)||isNaN(a.position.lng))throw Error("position is not valid! by:addLabel()");if(this.labels[a.id])throw Error("label id is exist! by:addLabel()");var b=parseFloat(a.altitude),c=Xb(parseFloat(a.position.lng)),d=Yb(parseFloat(a.position.lat)),e=this.pano.data.geoPos;this._pendingLabels?this._pendingLabels.push(a):(b=Zb(e.x,e.y,c,d,b),c=document.createElement("div"),c.style.backgroundColor="rgba(0,0,0,0.6)",c.style.position="absolute",c.textContent=a.content,c.style.whiteSpace="nowrap",c.style.color="rgba(255,255,255,1)",c.style.padding="2px",c.id=a.id,c.addEventListener("touchstart",$(this.onLabelEvent,this,{id:a.id,type:"touchstart"}),!1),c.addEventListener("touchend",$(this.onLabelEvent,this,{id:a.id,type:"touchend"}),!1),c.addEventListener("touchcancel",$(this.onLabelEvent,this,{id:a.id,type:"touchcancel"}),!1),c.addEventListener("click",$(this.onLabelEvent,this,{id:a.id,type:"click"}),!1),this._markerContainer.appendChild(c),b=this.pano.addMarker(b.heading,b.pitch,c,a.visible),this.labels[a.id]=b,this.labelsOpt[a.id]=a,this.pano.refreshMarkersPosition([b]))};A.addMarker=function(a){if(this._pendingMarkers)this._pendingMarkers.push(a);else{var b=document.createElement("div");b.style.position="absolute";b.textContent=a.content;b.id=a.id;this._markerContainer.appendChild(b);b=this.pano.addMarker(a.pov.heading,a.pov.pitch,b,a.visible);this.markers[a.id]=b;this.markersOpt[a.id]=a;this.pano.refreshMarkersPosition([b])}};A.removeMarker=function(a){this._pendingMarkers?this._pendingMarkers=this._pendingMarkers.filter(function(a){return a.id!==id}):(this.pano.removeMarker(this.markers[id]),delete this.markers[id],delete this.markersOpt[id])};A._updateLabelPov=function(){var a=[],b;for(b in this.labels){var c=this.labelsOpt[b];this.removeLabel(b);a.push(c)}for(b=a.length-1;0<=b;b--)this.addLabel(a[b])};A.removeLabel=function(a){this._pendingLabels?this._pendingLabels=this._pendingLabels.filter(function(b){return b.id!==a}):(this.pano.removeMarker(this.labels[a]),delete this.labels[a],delete this.labelsOpt[a])};A.setThumb=function(a){this.pano.setThumb(a.cube)};A.addPlugin=function(){};A.autoPlayStart=function(a){if(0==a)clearInterval(this.autoPlaytime);else{var b=this;clearInterval(this.autoPlaytime);a=a?16*a*Math.PI/180:1.44;this.autoPlaytime=setInterval(function(){var c=b.pano.getHeading()+a;b.pano.setPov({heading:c})},50)}};A.autoPlayStop=function(){clearInterval(this.autoPlaytime)};A.setKeyStatus=function(){};A.setVisible=function(a){this.pano._panoContainer.style.visibility=a?"visible":"hidden"};var Qa=window.qq||(window.qq={});Qa.pano=Qa.pano||{};Qa.pano.Panorama=rb})();
